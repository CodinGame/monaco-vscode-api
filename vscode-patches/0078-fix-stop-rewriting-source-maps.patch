From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lo=C3=AFc=20Mangeonjean?= <loic@coderpad.io>
Date: Mon, 29 Sep 2025 12:24:50 +0200
Subject: [PATCH] fix: stop rewriting source maps

---
 build/gulpfile.extensions.ts |  5 +----
 build/gulpfile.vscode.ts     |  1 -
 build/lib/extensions.ts      | 14 --------------
 3 files changed, 1 insertion(+), 19 deletions(-)

diff --git a/build/gulpfile.extensions.ts b/build/gulpfile.extensions.ts
index 6f5cf0d25d8..dce870fcc09 100644
--- a/build/gulpfile.extensions.ts
+++ b/build/gulpfile.extensions.ts
@@ -76,8 +76,6 @@ const compilations = [
 	'.vscode/extensions/vscode-selfhost-import-aid/tsconfig.json',
 ];
 
-const getBaseUrl = (out: string) => `https://main.vscode-cdn.net/sourcemaps/${commit}/${out}`;
-
 const tasks = compilations.map(function (tsconfigFile) {
 	const absolutePath = path.join(root, tsconfigFile);
 	const relativeDirname = path.dirname(tsconfigFile.replace(/^(.*\/)?extensions\//i, ''));
@@ -93,7 +91,6 @@ const tasks = compilations.map(function (tsconfigFile) {
 	const srcOpts = { cwd: root, base: srcBase, dot: true };
 
 	const out = path.join(srcRoot, 'out');
-	const baseUrl = getBaseUrl(out);
 
 	function createPipeline(build: boolean, emitError?: boolean, transpileOnly?: boolean) {
 		const reporter = createReporter('extensions');
@@ -119,7 +116,7 @@ const tasks = compilations.map(function (tsconfigFile) {
 				.pipe(compilation())
 				.pipe(build ? util.stripSourceMappingURL() : es.through())
 				.pipe(sourcemaps.write('.', {
-					sourceMappingURL: !build ? undefined : f => `${baseUrl}/${f.relative}.map`,
+					sourceMappingURL: null,
 					addComment: !!build,
 					includeContent: !!build,
 					// note: trailing slash is important, else the source URLs in V8's file coverage are incorrect
diff --git a/build/gulpfile.vscode.ts b/build/gulpfile.vscode.ts
index ac70ecbd57f..25ebeb7a266 100644
--- a/build/gulpfile.vscode.ts
+++ b/build/gulpfile.vscode.ts
@@ -293,7 +293,6 @@ function packageTask(platform: string, arch: string, sourceFolderName: string, d
 			.pipe(util.cleanNodeModules(path.join(import.meta.dirname, '.moduleignore')))
 			.pipe(util.cleanNodeModules(path.join(import.meta.dirname, `.moduleignore.${process.platform}`)))
 			.pipe(jsFilter)
-			.pipe(util.rewriteSourceMappingURL(sourceMappingURLBase))
 			.pipe(jsFilter.restore)
 			.pipe(createAsar(path.join(process.cwd(), 'node_modules'), [
 				'**/*.node',
diff --git a/build/lib/extensions.ts b/build/lib/extensions.ts
index 24462a3b26e..cb733cde061 100644
--- a/build/lib/extensions.ts
+++ b/build/lib/extensions.ts
@@ -23,7 +23,6 @@ import * as jsoncParser from 'jsonc-parser';
 import webpack from 'webpack';
 import { getProductionDependencies } from './dependencies.ts';
 import { type IExtensionDefinition, getExtensionStream } from './builtInExtensions.ts';
-import { getVersion } from './getVersion.ts';
 import { fetchUrls, fetchGithub } from './fetch.ts';
 import vzip from 'gulp-vinyl-zip';
 
@@ -31,8 +30,6 @@ import { createRequire } from 'module';
 const require = createRequire(import.meta.url);
 
 const root = path.dirname(path.dirname(import.meta.dirname));
-const commit = getVersion(root);
-const sourceMappingURLBase = `https://main.vscode-cdn.net/sourcemaps/${commit}`;
 
 function minifyExtensionResources(input: Stream): Stream {
 	const jsonFilter = filter(['**/*.json', '**/*.code-snippets'], { restore: true });
@@ -164,7 +161,6 @@ function fromLocalWebpack(extensionPath: string, webpackConfigFileName: string,
 						}
 					}
 				}
-				const relativeOutputPath = path.relative(extensionPath, webpackConfig.output.path);
 
 				return webpackGulp(webpackConfig, webpack, webpackDone)
 					.pipe(es.through(function (data) {
@@ -173,16 +169,6 @@ function fromLocalWebpack(extensionPath: string, webpackConfigFileName: string,
 						this.emit('data', data);
 					}))
 					.pipe(es.through(function (data: File) {
-						// source map handling:
-						// * rewrite sourceMappingURL
-						// * save to disk so that upload-task picks this up
-						if (path.extname(data.basename) === '.js') {
-							const contents = (data.contents as Buffer).toString('utf8');
-							data.contents = Buffer.from(contents.replace(/\n\/\/# sourceMappingURL=(.*)$/gm, function (_m, g1) {
-								return `\n//# sourceMappingURL=${sourceMappingURLBase}/extensions/${path.basename(extensionPath)}/${relativeOutputPath}/${g1}`;
-							}), 'utf8');
-						}
-
 						this.emit('data', data);
 					}));
 			});
