From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lo=C3=AFc=20Mangeonjean?= <loic@coderpad.io>
Date: Thu, 31 Oct 2024 12:20:04 +0100
Subject: [PATCH] fix: store activeChatController in another module

---
 .../chat/browser/terminalChatAccessibleView.ts  |  3 ++-
 .../chat/browser/terminalChatActions.ts         | 17 +++++++++--------
 .../chat/browser/terminalChatController.ts      | 10 +++-------
 .../browser/terminalChatControllerHolder.ts     | 15 +++++++++++++++
 4 files changed, 29 insertions(+), 16 deletions(-)
 create mode 100644 src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatControllerHolder.ts

diff --git a/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatAccessibleView.ts b/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatAccessibleView.ts
index 734ac7e62a6..8dc5b8133db 100644
--- a/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatAccessibleView.ts
+++ b/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatAccessibleView.ts
@@ -12,6 +12,7 @@ import { ServicesAccessor } from '../../../../../platform/instantiation/common/i
 import { IMenuService, MenuItemAction } from '../../../../../platform/actions/common/actions.js';
 import { MENU_TERMINAL_CHAT_WIDGET_STATUS, TerminalChatContextKeys } from './terminalChat.js';
 import { IAction } from '../../../../../base/common/actions.js';
+import { activeChatController } from './terminalChatControllerHolder.js';
 
 export class TerminalInlineChatAccessibleView implements IAccessibleViewImplementation {
 	readonly priority = 105;
@@ -23,7 +24,7 @@ export class TerminalInlineChatAccessibleView implements IAccessibleViewImplemen
 		const terminalService = accessor.get(ITerminalService);
 		const menuService = accessor.get(IMenuService);
 		const actions: IAction[] = [];
-		const contextKeyService = TerminalChatController.activeChatController?.scopedContextKeyService;
+		const contextKeyService = activeChatController?.scopedContextKeyService;
 		if (contextKeyService) {
 			const menuActions = menuService.getMenuActions(MENU_TERMINAL_CHAT_WIDGET_STATUS, contextKeyService);
 			for (const action of menuActions) {
diff --git a/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatActions.ts b/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatActions.ts
index 93ff50574a2..96359df33a4 100644
--- a/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatActions.ts
+++ b/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatActions.ts
@@ -25,6 +25,7 @@ import { IInstantiationService, ServicesAccessor } from '../../../../../platform
 import { getIconId } from '../../../terminal/browser/terminalIcon.js';
 import { TerminalChatController } from './terminalChatController.js';
 import { TerminalCapability } from '../../../../../platform/terminal/common/capabilities/capabilities.js';
+import { activeChatController } from './terminalChatControllerHolder.js';
 
 registerActiveXtermAction({
 	id: TerminalChatCommandId.Start,
@@ -53,7 +54,7 @@ registerActiveXtermAction({
 			return;
 		}
 
-		const contr = TerminalChatController.activeChatController || TerminalChatController.get(activeInstance);
+		const contr = activeChatController || TerminalChatController.get(activeInstance);
 
 		if (opts) {
 			opts = typeof opts === 'string' ? { query: opts } : opts;
@@ -97,7 +98,7 @@ registerActiveXtermAction({
 		if (isDetachedTerminalInstance(activeInstance)) {
 			return;
 		}
-		const contr = TerminalChatController.activeChatController || TerminalChatController.get(activeInstance);
+		const contr = activeChatController || TerminalChatController.get(activeInstance);
 		contr?.terminalChatWidget?.clear();
 	}
 });
@@ -130,7 +131,7 @@ registerActiveXtermAction({
 		if (isDetachedTerminalInstance(activeInstance)) {
 			return;
 		}
-		const contr = TerminalChatController.activeChatController || TerminalChatController.get(activeInstance);
+		const contr = activeChatController || TerminalChatController.get(activeInstance);
 		contr?.terminalChatWidget?.acceptCommand(true);
 	}
 });
@@ -162,7 +163,7 @@ registerActiveXtermAction({
 		if (isDetachedTerminalInstance(activeInstance)) {
 			return;
 		}
-		const contr = TerminalChatController.activeChatController || TerminalChatController.get(activeInstance);
+		const contr = activeChatController || TerminalChatController.get(activeInstance);
 		contr?.terminalChatWidget?.acceptCommand(true);
 	}
 });
@@ -196,7 +197,7 @@ registerActiveXtermAction({
 		if (isDetachedTerminalInstance(activeInstance)) {
 			return;
 		}
-		const contr = TerminalChatController.activeChatController || TerminalChatController.get(activeInstance);
+		const contr = activeChatController || TerminalChatController.get(activeInstance);
 		contr?.terminalChatWidget?.acceptCommand(false);
 	}
 });
@@ -228,7 +229,7 @@ registerActiveXtermAction({
 		if (isDetachedTerminalInstance(activeInstance)) {
 			return;
 		}
-		const contr = TerminalChatController.activeChatController || TerminalChatController.get(activeInstance);
+		const contr = activeChatController || TerminalChatController.get(activeInstance);
 		contr?.terminalChatWidget?.acceptCommand(false);
 	}
 });
@@ -258,7 +259,7 @@ registerActiveXtermAction({
 	run: async (_xterm, _accessor, activeInstance) => {
 		const chatService = _accessor.get(IChatService);
 		const chatWidgetService = _accessor.get(IChatWidgetService);
-		const contr = TerminalChatController.activeChatController;
+		const contr = activeChatController;
 		const model = contr?.terminalChatWidget?.inlineChatWidget.chatWidget.viewModel?.model;
 		if (!model) {
 			return;
@@ -298,7 +299,7 @@ registerActiveXtermAction({
 		if (isDetachedTerminalInstance(activeInstance)) {
 			return;
 		}
-		const contr = TerminalChatController.activeChatController || TerminalChatController.get(activeInstance);
+		const contr = activeChatController || TerminalChatController.get(activeInstance);
 		contr?.viewInChat();
 	}
 });
diff --git a/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatController.ts b/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatController.ts
index bd1710a7f27..e420de534ce 100644
--- a/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatController.ts
+++ b/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatController.ts
@@ -17,6 +17,7 @@ import type { ITerminalContributionContext } from '../../../terminal/browser/ter
 import type { IChatModel } from '../../../chat/common/chatModel.js';
 import { IChatEntitlementService } from '../../../../services/chat/common/chatEntitlementService.js';
 import { IWorkbenchLayoutService } from '../../../../services/layout/browser/layoutService.js';
+import { setActiveChatController } from './terminalChatControllerHolder.js';
 
 export class TerminalChatController extends Disposable implements ITerminalContribution {
 	static readonly ID = 'terminal.chat';
@@ -24,11 +25,6 @@ export class TerminalChatController extends Disposable implements ITerminalContr
 	static get(instance: ITerminalInstance): TerminalChatController | null {
 		return instance.getContribution<TerminalChatController>(TerminalChatController.ID);
 	}
-	/**
-	 * The controller for the currently focused chat widget. This is used to track action context since 'active terminals'
-	 * are only tracked for non-detached terminal instanecs.
-	 */
-	static activeChatController?: TerminalChatController;
 
 	/**
 	 * The chat widget for the controller, this is lazy as we don't want to instantiate it until
@@ -87,13 +83,13 @@ export class TerminalChatController extends Disposable implements ITerminalContr
 		this._terminalChatWidget = new Lazy(() => {
 			const chatWidget = this._register(this._instantiationService.createInstance(TerminalChatWidget, this._ctx.instance.domElement!, this._ctx.instance, xterm));
 			this._register(chatWidget.focusTracker.onDidFocus(() => {
-				TerminalChatController.activeChatController = this;
+				setActiveChatController(this);
 				if (!isDetachedTerminalInstance(this._ctx.instance)) {
 					this._terminalService.setActiveInstance(this._ctx.instance);
 				}
 			}));
 			this._register(chatWidget.focusTracker.onDidBlur(() => {
-				TerminalChatController.activeChatController = undefined;
+				setActiveChatController(undefined);
 				this._ctx.instance.resetScrollbarVisibility();
 			}));
 			if (!this._ctx.instance.domElement) {
diff --git a/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatControllerHolder.ts b/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatControllerHolder.ts
new file mode 100644
index 00000000000..bb67971614b
--- /dev/null
+++ b/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatControllerHolder.ts
@@ -0,0 +1,15 @@
+/*---------------------------------------------------------------------------------------------
+ *  Copyright (c) Microsoft Corporation. All rights reserved.
+ *  Licensed under the MIT License. See License.txt in the project root for license information.
+ *--------------------------------------------------------------------------------------------*/
+import { TerminalChatController } from './terminalChatController.js';
+
+/**
+ * The controller for the currently focused chat widget. This is used to track action context since 'active terminals'
+ * are only tracked for non-detached terminal instanecs.
+ */
+export let activeChatController: TerminalChatController | undefined;
+
+export function setActiveChatController(_activeChatController: TerminalChatController | undefined) {
+	activeChatController = _activeChatController;
+}
