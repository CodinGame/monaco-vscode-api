From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Onora Hubleur <onora.hubleur@coderpad.io>
Date: Wed, 18 Jun 2025 12:38:17 +0200
Subject: [PATCH] fix: break cyclic dependency

---
 .../contrib/chat/browser/actions/chatConstants.ts         | 4 ++++
 .../workbench/contrib/chat/browser/actions/chatContext.ts | 3 ++-
 .../contrib/chat/browser/actions/chatToolActions.ts       | 5 +----
 .../contrib/chat/browser/chatAccessibilityProvider.ts     | 2 +-
 .../contrib/chat/browser/chatAttachmentResolveService.ts  | 3 +--
 .../chatExtensionsInstallToolSubPart.ts                   | 2 +-
 .../chatTerminalToolConfirmationSubPart.ts                | 2 +-
 .../toolInvocationParts/chatToolConfirmationSubPart.ts    | 2 +-
 .../chatToolPostExecuteConfirmationPart.ts                | 2 +-
 .../workbench/contrib/chat/browser/chatPasteProviders.ts  | 8 +-------
 src/vs/workbench/contrib/chat/browser/imageUtils.ts       | 6 ++++++
 11 files changed, 20 insertions(+), 19 deletions(-)

diff --git a/src/vs/workbench/contrib/chat/browser/actions/chatConstants.ts b/src/vs/workbench/contrib/chat/browser/actions/chatConstants.ts
index 6ce67486a58..17e137b5eb0 100644
--- a/src/vs/workbench/contrib/chat/browser/actions/chatConstants.ts
+++ b/src/vs/workbench/contrib/chat/browser/actions/chatConstants.ts
@@ -7,4 +7,8 @@ import { localize2 } from '../../../../../nls.js';
 export const CHAT_CATEGORY = localize2('chat.category', 'Chat');
 export const CHAT_OPEN_ACTION_ID = 'workbench.action.chat.open';
 export const ASK_QUICK_QUESTION_ACTION_ID = 'workbench.action.quickchat.toggle';
+export const AcceptToolConfirmationActionId = 'workbench.action.chat.acceptTool';
+export const SkipToolConfirmationActionId = 'workbench.action.chat.skipTool';
+export const AcceptToolPostConfirmationActionId = 'workbench.action.chat.acceptToolPostExecution';
+export const SkipToolPostConfirmationActionId = 'workbench.action.chat.skipToolPostExecution';
 
diff --git a/src/vs/workbench/contrib/chat/browser/actions/chatContext.ts b/src/vs/workbench/contrib/chat/browser/actions/chatContext.ts
index 80d3960d635..0a69d3f1df6 100644
--- a/src/vs/workbench/contrib/chat/browser/actions/chatContext.ts
+++ b/src/vs/workbench/contrib/chat/browser/actions/chatContext.ts
@@ -26,8 +26,9 @@ import { IChatEditingService } from '../../common/chatEditingService.js';
 import { IChatRequestToolEntry, IChatRequestToolSetEntry, IChatRequestVariableEntry, IImageVariableEntry, OmittedState, toToolSetVariableEntry, toToolVariableEntry } from '../../common/chatVariableEntries.js';
 import { ToolDataSource, ToolSet } from '../../common/languageModelToolsService.js';
 import { IChatWidget } from '../chat.js';
-import { imageToHash, isImage } from '../chatPasteProviders.js';
+import { isImage } from '../chatPasteProviders.js';
 import { convertBufferToScreenshotVariable } from '../contrib/screenshot.js';
+import { imageToHash } from '../imageUtils.js';
 import { ChatInstructionsPickerPick } from '../promptSyntax/attachInstructionsAction.js';
 import { ITerminalService } from '../../../terminal/browser/terminal.js';
 import { URI } from '../../../../../base/common/uri.js';
diff --git a/src/vs/workbench/contrib/chat/browser/actions/chatToolActions.ts b/src/vs/workbench/contrib/chat/browser/actions/chatToolActions.ts
index 351fbb86479..e8425ed36a4 100644
--- a/src/vs/workbench/contrib/chat/browser/actions/chatToolActions.ts
+++ b/src/vs/workbench/contrib/chat/browser/actions/chatToolActions.ts
@@ -26,6 +26,7 @@ import { ChatModeKind } from '../../common/constants.js';
 import { IChatWidget, IChatWidgetService } from '../chat.js';
 import { ToolsScope } from '../chatSelectedTools.js';
 import { CHAT_CATEGORY } from './chatActions.js';
+import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from './chatConstants.js';
 import { showToolsPicker } from './chatToolPicker.js';
 
 
@@ -40,10 +41,6 @@ type SelectedToolClassification = {
 	total: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Number of total chat tools' };
 };
 
-export const AcceptToolConfirmationActionId = 'workbench.action.chat.acceptTool';
-export const SkipToolConfirmationActionId = 'workbench.action.chat.skipTool';
-export const AcceptToolPostConfirmationActionId = 'workbench.action.chat.acceptToolPostExecution';
-export const SkipToolPostConfirmationActionId = 'workbench.action.chat.skipToolPostExecution';
 
 abstract class ToolConfirmationAction extends Action2 {
 	protected abstract getReason(): ConfirmedReason;
diff --git a/src/vs/workbench/contrib/chat/browser/chatAccessibilityProvider.ts b/src/vs/workbench/contrib/chat/browser/chatAccessibilityProvider.ts
index 6a970d45271..059859843be 100644
--- a/src/vs/workbench/contrib/chat/browser/chatAccessibilityProvider.ts
+++ b/src/vs/workbench/contrib/chat/browser/chatAccessibilityProvider.ts
@@ -18,7 +18,7 @@ import { IChatToolInvocation } from '../common/chatService.js';
 import { IChatResponseViewModel, isRequestVM, isResponseVM } from '../common/chatViewModel.js';
 import { toolContentToA11yString } from '../common/languageModelToolsService.js';
 import { CancelChatActionId } from './actions/chatExecuteActions.js';
-import { AcceptToolConfirmationActionId } from './actions/chatToolActions.js';
+import { AcceptToolConfirmationActionId } from './actions/chatConstants.js';
 import { ChatTreeItem } from './chat.js';
 
 export const getToolConfirmationAlert = (accessor: ServicesAccessor, toolInvocation: IChatToolInvocation[]) => {
diff --git a/src/vs/workbench/contrib/chat/browser/chatAttachmentResolveService.ts b/src/vs/workbench/contrib/chat/browser/chatAttachmentResolveService.ts
index ceac2129e16..99427ed231b 100644
--- a/src/vs/workbench/contrib/chat/browser/chatAttachmentResolveService.ts
+++ b/src/vs/workbench/contrib/chat/browser/chatAttachmentResolveService.ts
@@ -29,8 +29,7 @@ import { SCMHistoryItemTransferData } from '../../scm/browser/scmHistoryChatCont
 import { CHAT_ATTACHABLE_IMAGE_MIME_TYPES, getAttachableImageExtension } from '../common/chatModel.js';
 import { IChatRequestVariableEntry, OmittedState, IDiagnosticVariableEntry, IDiagnosticVariableEntryFilterData, ISymbolVariableEntry, toPromptFileVariableEntry, PromptFileVariableKind, ISCMHistoryItemVariableEntry } from '../common/chatVariableEntries.js';
 import { getPromptsTypeForLanguageId, PromptsType } from '../common/promptSyntax/promptTypes.js';
-import { imageToHash } from './chatPasteProviders.js';
-import { resizeImage } from './imageUtils.js';
+import { resizeImage, imageToHash } from './imageUtils.js';
 
 export const IChatAttachmentResolveService = createDecorator<IChatAttachmentResolveService>('IChatAttachmentResolveService');
 
diff --git a/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatExtensionsInstallToolSubPart.ts b/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatExtensionsInstallToolSubPart.ts
index 7f19ecc763a..06b40cdd53a 100644
--- a/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatExtensionsInstallToolSubPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatExtensionsInstallToolSubPart.ts
@@ -14,8 +14,8 @@ import { IInstantiationService } from '../../../../../../platform/instantiation/
 import { IKeybindingService } from '../../../../../../platform/keybinding/common/keybinding.js';
 import { ChatContextKeys } from '../../../common/chatContextKeys.js';
 import { ConfirmedReason, IChatToolInvocation, ToolConfirmKind } from '../../../common/chatService.js';
+import { AcceptToolConfirmationActionId } from '../../actions/chatConstants.js';
 import { CancelChatActionId } from '../../actions/chatExecuteActions.js';
-import { AcceptToolConfirmationActionId } from '../../actions/chatToolActions.js';
 import { IChatWidgetService } from '../../chat.js';
 import { ChatConfirmationWidget, IChatConfirmationButton } from '../chatConfirmationWidget.js';
 import { IChatContentPartRenderContext } from '../chatContentParts.js';
diff --git a/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.ts b/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.ts
index ffd78ae9466..f8326d89d5c 100644
--- a/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.ts
@@ -36,7 +36,7 @@ import { migrateLegacyTerminalToolSpecificData } from '../../../common/chat.js';
 import { ChatContextKeys } from '../../../common/chatContextKeys.js';
 import { IChatToolInvocation, ToolConfirmKind, type IChatTerminalToolInvocationData, type ILegacyChatTerminalToolInvocationData } from '../../../common/chatService.js';
 import type { CodeBlockModelCollection } from '../../../common/codeBlockModelCollection.js';
-import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from '../../actions/chatToolActions.js';
+import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from '../../actions/chatConstants.js';
 import { IChatCodeBlockInfo, IChatWidgetService } from '../../chat.js';
 import { ICodeBlockRenderOptions } from '../../codeBlockPart.js';
 import { ChatCustomConfirmationWidget, IChatConfirmationButton } from '../chatConfirmationWidget.js';
diff --git a/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts b/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts
index 2cb1ebe91f5..701cf0c8139 100644
--- a/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts
@@ -25,7 +25,7 @@ import { IChatToolInvocation, ToolConfirmKind } from '../../../common/chatServic
 import { CodeBlockModelCollection } from '../../../common/codeBlockModelCollection.js';
 import { createToolInputUri, createToolSchemaUri, ILanguageModelToolsService } from '../../../common/languageModelToolsService.js';
 import { ILanguageModelToolsConfirmationService } from '../../../common/languageModelToolsConfirmationService.js';
-import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from '../../actions/chatToolActions.js';
+import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from '../../actions/chatConstants.js';
 import { IChatCodeBlockInfo, IChatWidgetService } from '../../chat.js';
 import { renderFileWidgets } from '../../chatInlineAnchorWidget.js';
 import { ICodeBlockRenderOptions } from '../../codeBlockPart.js';
diff --git a/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolPostExecuteConfirmationPart.ts b/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolPostExecuteConfirmationPart.ts
index 89e0c04609a..662f690981f 100644
--- a/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolPostExecuteConfirmationPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolPostExecuteConfirmationPart.ts
@@ -16,7 +16,7 @@ import { ChatResponseResource } from '../../../common/chatModel.js';
 import { IChatToolInvocation, ToolConfirmKind } from '../../../common/chatService.js';
 import { ILanguageModelToolsConfirmationService } from '../../../common/languageModelToolsConfirmationService.js';
 import { ILanguageModelToolsService, IToolResultDataPart, IToolResultPromptTsxPart, IToolResultTextPart, stringifyPromptTsxPart } from '../../../common/languageModelToolsService.js';
-import { AcceptToolPostConfirmationActionId, SkipToolPostConfirmationActionId } from '../../actions/chatToolActions.js';
+import { AcceptToolPostConfirmationActionId, SkipToolPostConfirmationActionId } from '../../actions/chatConstants.js';
 import { IChatCodeBlockInfo, IChatWidgetService } from '../../chat.js';
 import { IChatContentPartRenderContext } from '../chatContentParts.js';
 import { ChatCollapsibleIOPart } from '../chatToolInputOutputContentPart.js';
diff --git a/src/vs/workbench/contrib/chat/browser/chatPasteProviders.ts b/src/vs/workbench/contrib/chat/browser/chatPasteProviders.ts
index 6ea16686299..43124ee4d27 100644
--- a/src/vs/workbench/contrib/chat/browser/chatPasteProviders.ts
+++ b/src/vs/workbench/contrib/chat/browser/chatPasteProviders.ts
@@ -27,7 +27,7 @@ import { IChatRequestPasteVariableEntry, IChatRequestVariableEntry } from '../co
 import { IChatVariablesService, IDynamicVariable } from '../common/chatVariables.js';
 import { IChatWidgetService } from './chat.js';
 import { ChatDynamicVariableModel } from './contrib/chatDynamicVariables.js';
-import { cleanupOldImages, createFileForMedia, resizeImage } from './imageUtils.js';
+import { cleanupOldImages, createFileForMedia, imageToHash, resizeImage } from './imageUtils.js';
 
 const COPY_MIME_TYPES = 'application/vnd.code.additional-editor-data';
 
@@ -147,12 +147,6 @@ async function getImageAttachContext(data: Uint8Array, mimeType: string, token:
 	};
 }
 
-export async function imageToHash(data: Uint8Array): Promise<string> {
-	const hashBuffer = await crypto.subtle.digest('SHA-256', data);
-	const hashArray = Array.from(new Uint8Array(hashBuffer));
-	return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
-}
-
 export function isImage(array: Uint8Array): boolean {
 	if (array.length < 4) {
 		return false;
diff --git a/src/vs/workbench/contrib/chat/browser/imageUtils.ts b/src/vs/workbench/contrib/chat/browser/imageUtils.ts
index 89f1ecb1225..2876ed9e929 100644
--- a/src/vs/workbench/contrib/chat/browser/imageUtils.ts
+++ b/src/vs/workbench/contrib/chat/browser/imageUtils.ts
@@ -160,3 +160,9 @@ function getTimestampFromFilename(filename: string): number | undefined {
 	}
 	return undefined;
 }
+
+export async function imageToHash(data: Uint8Array): Promise<string> {
+	const hashBuffer = await crypto.subtle.digest('SHA-256', data);
+	const hashArray = Array.from(new Uint8Array(hashBuffer));
+	return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
+}
