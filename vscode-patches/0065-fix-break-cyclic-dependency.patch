From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Onora Hubleur <onora.hubleur@coderpad.io>
Date: Wed, 18 Jun 2025 12:38:17 +0200
Subject: [PATCH] fix: break cyclic dependency

---
 .../browser/accessibility/chatAccessibilityProvider.ts    | 2 +-
 .../contrib/chat/browser/actions/chatConstants.ts         | 4 ++++
 .../workbench/contrib/chat/browser/actions/chatContext.ts | 3 ++-
 .../contrib/chat/browser/actions/chatToolActions.ts       | 5 +----
 .../browser/attachments/chatAttachmentResolveService.ts   | 3 +--
 src/vs/workbench/contrib/chat/browser/chatImageUtils.ts   | 6 ++++++
 .../chatExtensionsInstallToolSubPart.ts                   | 2 +-
 .../chatTerminalToolConfirmationSubPart.ts                | 2 +-
 .../toolInvocationParts/chatToolConfirmationSubPart.ts    | 2 +-
 .../chatToolPostExecuteConfirmationPart.ts                | 2 +-
 .../browser/widget/input/editor/chatPasteProviders.ts     | 8 +-------
 11 files changed, 20 insertions(+), 19 deletions(-)

diff --git a/src/vs/workbench/contrib/chat/browser/accessibility/chatAccessibilityProvider.ts b/src/vs/workbench/contrib/chat/browser/accessibility/chatAccessibilityProvider.ts
index e468b666365..b82937adf63 100644
--- a/src/vs/workbench/contrib/chat/browser/accessibility/chatAccessibilityProvider.ts
+++ b/src/vs/workbench/contrib/chat/browser/accessibility/chatAccessibilityProvider.ts
@@ -18,7 +18,7 @@ import { IChatToolInvocation } from '../../common/chatService/chatService.js';
 import { IChatResponseViewModel, isRequestVM, isResponseVM } from '../../common/model/chatViewModel.js';
 import { isToolResultInputOutputDetails, isToolResultOutputDetails, toolContentToA11yString } from '../../common/tools/languageModelToolsService.js';
 import { CancelChatActionId } from '../actions/chatExecuteActions.js';
-import { AcceptToolConfirmationActionId } from '../actions/chatToolActions.js';
+import { AcceptToolConfirmationActionId } from '../actions/chatConstants.js';
 import { ChatTreeItem } from '../chat.js';
 
 export const getToolConfirmationAlert = (accessor: ServicesAccessor, toolInvocation: IChatToolInvocation[]) => {
diff --git a/src/vs/workbench/contrib/chat/browser/actions/chatConstants.ts b/src/vs/workbench/contrib/chat/browser/actions/chatConstants.ts
index 6ce67486a58..17e137b5eb0 100644
--- a/src/vs/workbench/contrib/chat/browser/actions/chatConstants.ts
+++ b/src/vs/workbench/contrib/chat/browser/actions/chatConstants.ts
@@ -7,4 +7,8 @@ import { localize2 } from '../../../../../nls.js';
 export const CHAT_CATEGORY = localize2('chat.category', 'Chat');
 export const CHAT_OPEN_ACTION_ID = 'workbench.action.chat.open';
 export const ASK_QUICK_QUESTION_ACTION_ID = 'workbench.action.quickchat.toggle';
+export const AcceptToolConfirmationActionId = 'workbench.action.chat.acceptTool';
+export const SkipToolConfirmationActionId = 'workbench.action.chat.skipTool';
+export const AcceptToolPostConfirmationActionId = 'workbench.action.chat.acceptToolPostExecution';
+export const SkipToolPostConfirmationActionId = 'workbench.action.chat.skipToolPostExecution';
 
diff --git a/src/vs/workbench/contrib/chat/browser/actions/chatContext.ts b/src/vs/workbench/contrib/chat/browser/actions/chatContext.ts
index 6154a9e95ce..3d019538444 100644
--- a/src/vs/workbench/contrib/chat/browser/actions/chatContext.ts
+++ b/src/vs/workbench/contrib/chat/browser/actions/chatContext.ts
@@ -26,12 +26,13 @@ import { IChatEditingService } from '../../common/editing/chatEditingService.js'
 import { IChatRequestToolEntry, IChatRequestToolSetEntry, IChatRequestVariableEntry, IImageVariableEntry, OmittedState, toToolSetVariableEntry, toToolVariableEntry } from '../../common/attachments/chatVariableEntries.js';
 import { ToolDataSource, ToolSet } from '../../common/tools/languageModelToolsService.js';
 import { IChatWidget } from '../chat.js';
-import { imageToHash, isImage } from '../widget/input/editor/chatPasteProviders.js';
+import { isImage } from '../widget/input/editor/chatPasteProviders.js';
 import { convertBufferToScreenshotVariable } from '../attachments/chatScreenshotContext.js';
 import { ChatInstructionsPickerPick } from '../promptSyntax/attachInstructionsAction.js';
 import { ITerminalService } from '../../../terminal/browser/terminal.js';
 import { URI } from '../../../../../base/common/uri.js';
 import { ITerminalCommand, TerminalCapability } from '../../../../../platform/terminal/common/capabilities/capabilities.js';
+import { imageToHash } from '../chatImageUtils.js';
 
 
 export class ChatContextContributions extends Disposable implements IWorkbenchContribution {
diff --git a/src/vs/workbench/contrib/chat/browser/actions/chatToolActions.ts b/src/vs/workbench/contrib/chat/browser/actions/chatToolActions.ts
index a8ad2887cac..5061f6937d2 100644
--- a/src/vs/workbench/contrib/chat/browser/actions/chatToolActions.ts
+++ b/src/vs/workbench/contrib/chat/browser/actions/chatToolActions.ts
@@ -28,6 +28,7 @@ import { ChatModeKind } from '../../common/constants.js';
 import { IChatWidget, IChatWidgetService } from '../chat.js';
 import { ToolsScope } from '../widget/input/chatSelectedTools.js';
 import { CHAT_CATEGORY } from './chatActions.js';
+import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from './chatConstants.js';
 import { showToolsPicker } from './chatToolPicker.js';
 
 
@@ -42,10 +43,6 @@ type SelectedToolClassification = {
 	total: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Number of total chat tools' };
 };
 
-export const AcceptToolConfirmationActionId = 'workbench.action.chat.acceptTool';
-export const SkipToolConfirmationActionId = 'workbench.action.chat.skipTool';
-export const AcceptToolPostConfirmationActionId = 'workbench.action.chat.acceptToolPostExecution';
-export const SkipToolPostConfirmationActionId = 'workbench.action.chat.skipToolPostExecution';
 
 abstract class ToolConfirmationAction extends Action2 {
 	protected abstract getReason(): ConfirmedReason;
diff --git a/src/vs/workbench/contrib/chat/browser/attachments/chatAttachmentResolveService.ts b/src/vs/workbench/contrib/chat/browser/attachments/chatAttachmentResolveService.ts
index 60e6559ffc3..b2659af705f 100644
--- a/src/vs/workbench/contrib/chat/browser/attachments/chatAttachmentResolveService.ts
+++ b/src/vs/workbench/contrib/chat/browser/attachments/chatAttachmentResolveService.ts
@@ -29,8 +29,7 @@ import { SCMHistoryItemTransferData } from '../../../scm/browser/scmHistoryChatC
 import { CHAT_ATTACHABLE_IMAGE_MIME_TYPES, getAttachableImageExtension } from '../../common/model/chatModel.js';
 import { IChatRequestVariableEntry, OmittedState, IDiagnosticVariableEntry, IDiagnosticVariableEntryFilterData, ISymbolVariableEntry, toPromptFileVariableEntry, PromptFileVariableKind, ISCMHistoryItemVariableEntry } from '../../common/attachments/chatVariableEntries.js';
 import { getPromptsTypeForLanguageId, PromptsType } from '../../common/promptSyntax/promptTypes.js';
-import { imageToHash } from '../widget/input/editor/chatPasteProviders.js';
-import { resizeImage } from '../chatImageUtils.js';
+import { resizeImage, imageToHash } from '../chatImageUtils.js';
 
 export const IChatAttachmentResolveService = createDecorator<IChatAttachmentResolveService>('IChatAttachmentResolveService');
 
diff --git a/src/vs/workbench/contrib/chat/browser/chatImageUtils.ts b/src/vs/workbench/contrib/chat/browser/chatImageUtils.ts
index 89f1ecb1225..2876ed9e929 100644
--- a/src/vs/workbench/contrib/chat/browser/chatImageUtils.ts
+++ b/src/vs/workbench/contrib/chat/browser/chatImageUtils.ts
@@ -160,3 +160,9 @@ function getTimestampFromFilename(filename: string): number | undefined {
 	}
 	return undefined;
 }
+
+export async function imageToHash(data: Uint8Array): Promise<string> {
+	const hashBuffer = await crypto.subtle.digest('SHA-256', data);
+	const hashArray = Array.from(new Uint8Array(hashBuffer));
+	return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
+}
diff --git a/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatExtensionsInstallToolSubPart.ts b/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatExtensionsInstallToolSubPart.ts
index 726ce214681..238770697f8 100644
--- a/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatExtensionsInstallToolSubPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatExtensionsInstallToolSubPart.ts
@@ -15,7 +15,7 @@ import { IKeybindingService } from '../../../../../../../platform/keybinding/com
 import { ChatContextKeys } from '../../../../common/actions/chatContextKeys.js';
 import { ConfirmedReason, IChatToolInvocation, ToolConfirmKind } from '../../../../common/chatService/chatService.js';
 import { CancelChatActionId } from '../../../actions/chatExecuteActions.js';
-import { AcceptToolConfirmationActionId } from '../../../actions/chatToolActions.js';
+import { AcceptToolConfirmationActionId } from '../../../actions/chatConstants.js';
 import { IChatWidgetService } from '../../../chat.js';
 import { ChatConfirmationWidget, IChatConfirmationButton } from '../chatConfirmationWidget.js';
 import { IChatContentPartRenderContext } from '../chatContentParts.js';
diff --git a/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.ts b/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.ts
index 0358e6a89b2..84993ba0721 100644
--- a/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.ts
@@ -36,7 +36,7 @@ import { migrateLegacyTerminalToolSpecificData } from '../../../../common/chat.j
 import { ChatContextKeys } from '../../../../common/actions/chatContextKeys.js';
 import { IChatToolInvocation, ToolConfirmKind, type IChatTerminalToolInvocationData, type ILegacyChatTerminalToolInvocationData } from '../../../../common/chatService/chatService.js';
 import type { CodeBlockModelCollection } from '../../../../common/widget/codeBlockModelCollection.js';
-import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from '../../../actions/chatToolActions.js';
+import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from '../../../actions/chatConstants.js';
 import { IChatCodeBlockInfo, IChatWidgetService } from '../../../chat.js';
 import { ICodeBlockRenderOptions } from '../codeBlockPart.js';
 import { ChatCustomConfirmationWidget, IChatConfirmationButton } from '../chatConfirmationWidget.js';
diff --git a/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts b/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts
index 859421939a0..658fae422dc 100644
--- a/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolConfirmationSubPart.ts
@@ -25,7 +25,7 @@ import { IChatToolInvocation, ToolConfirmKind } from '../../../../common/chatSer
 import { CodeBlockModelCollection } from '../../../../common/widget/codeBlockModelCollection.js';
 import { createToolInputUri, createToolSchemaUri, ILanguageModelToolsService } from '../../../../common/tools/languageModelToolsService.js';
 import { ILanguageModelToolsConfirmationService } from '../../../../common/tools/languageModelToolsConfirmationService.js';
-import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from '../../../actions/chatToolActions.js';
+import { AcceptToolConfirmationActionId, SkipToolConfirmationActionId } from '../../../actions/chatConstants.js';
 import { IChatCodeBlockInfo, IChatWidgetService } from '../../../chat.js';
 import { renderFileWidgets } from '../chatInlineAnchorWidget.js';
 import { ICodeBlockRenderOptions } from '../codeBlockPart.js';
diff --git a/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolPostExecuteConfirmationPart.ts b/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolPostExecuteConfirmationPart.ts
index 54ba1affb72..4b4bd885c92 100644
--- a/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolPostExecuteConfirmationPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/widget/chatContentParts/toolInvocationParts/chatToolPostExecuteConfirmationPart.ts
@@ -16,7 +16,7 @@ import { ChatResponseResource } from '../../../../common/model/chatModel.js';
 import { IChatToolInvocation, ToolConfirmKind } from '../../../../common/chatService/chatService.js';
 import { ILanguageModelToolsConfirmationService } from '../../../../common/tools/languageModelToolsConfirmationService.js';
 import { ILanguageModelToolsService, IToolResultDataPart, IToolResultPromptTsxPart, IToolResultTextPart, stringifyPromptTsxPart } from '../../../../common/tools/languageModelToolsService.js';
-import { AcceptToolPostConfirmationActionId, SkipToolPostConfirmationActionId } from '../../../actions/chatToolActions.js';
+import { AcceptToolPostConfirmationActionId, SkipToolPostConfirmationActionId } from '../../../actions/chatConstants.js';
 import { IChatCodeBlockInfo, IChatWidgetService } from '../../../chat.js';
 import { IChatContentPartRenderContext } from '../chatContentParts.js';
 import { ChatCollapsibleIOPart } from '../chatToolInputOutputContentPart.js';
diff --git a/src/vs/workbench/contrib/chat/browser/widget/input/editor/chatPasteProviders.ts b/src/vs/workbench/contrib/chat/browser/widget/input/editor/chatPasteProviders.ts
index 65089b20200..99564aefe58 100644
--- a/src/vs/workbench/contrib/chat/browser/widget/input/editor/chatPasteProviders.ts
+++ b/src/vs/workbench/contrib/chat/browser/widget/input/editor/chatPasteProviders.ts
@@ -27,7 +27,7 @@ import { IChatRequestPasteVariableEntry, IChatRequestVariableEntry } from '../..
 import { IChatVariablesService, IDynamicVariable } from '../../../../common/attachments/chatVariables.js';
 import { IChatWidgetService } from '../../../chat.js';
 import { ChatDynamicVariableModel } from '../../../attachments/chatDynamicVariables.js';
-import { cleanupOldImages, createFileForMedia, resizeImage } from '../../../chatImageUtils.js';
+import { cleanupOldImages, createFileForMedia, imageToHash, resizeImage } from '../../../chatImageUtils.js';
 
 const COPY_MIME_TYPES = 'application/vnd.code.additional-editor-data';
 
@@ -147,12 +147,6 @@ async function getImageAttachContext(data: Uint8Array, mimeType: string, token:
 	};
 }
 
-export async function imageToHash(data: Uint8Array): Promise<string> {
-	const hashBuffer = await crypto.subtle.digest('SHA-256', data);
-	const hashArray = Array.from(new Uint8Array(hashBuffer));
-	return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
-}
-
 export function isImage(array: Uint8Array): boolean {
 	if (array.length < 4) {
 		return false;
