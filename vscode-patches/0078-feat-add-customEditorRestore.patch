From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lo=C3=AFc=20Mangeonjean?= <loic@coderpad.io>
Date: Tue, 23 Sep 2025 11:13:34 +0200
Subject: [PATCH] feat: add customEditorRestore

---
 src/vs/workbench/browser/layout.ts    | 61 ++++++++++++++-------------
 src/vs/workbench/browser/workbench.ts | 12 +++---
 2 files changed, 39 insertions(+), 34 deletions(-)

diff --git a/src/vs/workbench/browser/layout.ts b/src/vs/workbench/browser/layout.ts
index 7260c7a7f63..f7379482bd6 100644
--- a/src/vs/workbench/browser/layout.ts
+++ b/src/vs/workbench/browser/layout.ts
@@ -12,42 +12,42 @@ import { coalesce } from '../../base/common/arrays.js';
 import { DeferredPromise, Promises } from '../../base/common/async.js';
 import { Emitter, Event } from '../../base/common/event.js';
 import { Disposable, DisposableMap, DisposableStore, IDisposable, toDisposable } from '../../base/common/lifecycle.js';
-import { isWindows, isLinux, isMacintosh, isWeb, isIOS } from '../../base/common/platform.js';
-import { EditorInputCapabilities, GroupIdentifier, isResourceEditorInput, IUntypedEditorInput, pathsToEditors } from '../common/editor.js';
-import { SidebarPart } from './parts/sidebar/sidebarPart.js';
-import { PanelPart } from './parts/panel/panelPart.js';
-import { Position, Parts, PartOpensMaximizedOptions, IWorkbenchLayoutService, positionFromString, positionToString, partOpensMaximizedFromString, PanelAlignment, ActivityBarPosition, LayoutSettings, MULTI_WINDOW_PARTS, SINGLE_WINDOW_PARTS, ZenModeSettings, EditorTabsMode, EditorActionsLocation, shouldShowCustomTitleBar, isHorizontal, isMultiWindowPart } from '../services/layout/browser/layoutService.js';
-import { isTemporaryWorkspace, IWorkspaceContextService, WorkbenchState } from '../../platform/workspace/common/workspace.js';
-import { IStorageService, StorageScope, StorageTarget } from '../../platform/storage/common/storage.js';
+import { mark } from '../../base/common/performance.js';
+import { isIOS, isLinux, isMacintosh, isWeb, isWindows } from '../../base/common/platform.js';
+import { assertReturnsDefined } from '../../base/common/types.js';
+import { URI } from '../../base/common/uri.js';
+import { isCodeEditor } from '../../editor/browser/editorBrowser.js';
+import { LineNumbersType } from '../../editor/common/config/editorOptions.js';
 import { IConfigurationChangeEvent, IConfigurationService, isConfigured } from '../../platform/configuration/common/configuration.js';
-import { ITitleService } from '../services/title/browser/titleService.js';
-import { ServicesAccessor } from '../../platform/instantiation/common/instantiation.js';
-import { StartupKind, ILifecycleService } from '../services/lifecycle/common/lifecycle.js';
-import { getMenuBarVisibility, IPath, hasNativeTitlebar, hasCustomTitlebar, TitleBarSetting, CustomTitleBarVisibility, useWindowControlsOverlay, DEFAULT_EMPTY_WINDOW_SIZE, DEFAULT_WORKSPACE_WINDOW_SIZE, hasNativeMenu, MenuSettings } from '../../platform/window/common/window.js';
-import { IHostService } from '../services/host/browser/host.js';
-import { IBrowserWorkbenchEnvironmentService } from '../services/environment/browser/environmentService.js';
-import { IEditorService } from '../services/editor/common/editorService.js';
-import { EditorGroupLayout, GroupOrientation, GroupsOrder, IEditorGroupsService } from '../services/editor/common/editorGroupsService.js';
-import { Part } from './part.js';
-import { IStatusbarService } from '../services/statusbar/browser/statusbar.js';
 import { IFileService } from '../../platform/files/common/files.js';
-import { isCodeEditor } from '../../editor/browser/editorBrowser.js';
-import { assertReturnsDefined } from '../../base/common/types.js';
+import { IInstantiationService, ServicesAccessor } from '../../platform/instantiation/common/instantiation.js';
+import { ILogService } from '../../platform/log/common/log.js';
 import { INotificationService, NotificationsFilter } from '../../platform/notification/common/notification.js';
+import { IStorageService, StorageScope, StorageTarget } from '../../platform/storage/common/storage.js';
+import { ITelemetryService } from '../../platform/telemetry/common/telemetry.js';
 import { IThemeService } from '../../platform/theme/common/themeService.js';
+import { CustomTitleBarVisibility, DEFAULT_EMPTY_WINDOW_SIZE, DEFAULT_WORKSPACE_WINDOW_SIZE, getMenuBarVisibility, hasCustomTitlebar, hasNativeMenu, hasNativeTitlebar, IPath, MenuSettings, TitleBarSetting, useWindowControlsOverlay } from '../../platform/window/common/window.js';
+import { isTemporaryWorkspace, IWorkspaceContextService, WorkbenchState } from '../../platform/workspace/common/workspace.js';
+import { EditorInputCapabilities, GroupIdentifier, isResourceEditorInput, IUntypedEditorInput, pathsToEditors } from '../common/editor.js';
+import { DiffEditorInput } from '../common/editor/diffEditorInput.js';
 import { WINDOW_ACTIVE_BORDER, WINDOW_INACTIVE_BORDER } from '../common/theme.js';
-import { LineNumbersType } from '../../editor/common/config/editorOptions.js';
-import { URI } from '../../base/common/uri.js';
 import { IViewDescriptorService, ViewContainerLocation } from '../common/views.js';
-import { DiffEditorInput } from '../common/editor/diffEditorInput.js';
-import { mark } from '../../base/common/performance.js';
-import { IExtensionService } from '../services/extensions/common/extensions.js';
-import { ILogService } from '../../platform/log/common/log.js';
+import { IAuxiliaryWindowService } from '../services/auxiliaryWindow/browser/auxiliaryWindowService.js';
 import { IBannerService } from '../services/banner/browser/bannerService.js';
+import { EditorGroupLayout, GroupOrientation, GroupsOrder, IEditorGroupsService } from '../services/editor/common/editorGroupsService.js';
+import { IEditorService } from '../services/editor/common/editorService.js';
+import { IBrowserWorkbenchEnvironmentService } from '../services/environment/browser/environmentService.js';
+import { IExtensionService } from '../services/extensions/common/extensions.js';
+import { IHostService } from '../services/host/browser/host.js';
+import { ActivityBarPosition, EditorActionsLocation, EditorTabsMode, isHorizontal, isMultiWindowPart, IWorkbenchLayoutService, LayoutSettings, MULTI_WINDOW_PARTS, PanelAlignment, partOpensMaximizedFromString, PartOpensMaximizedOptions, Parts, Position, positionFromString, positionToString, shouldShowCustomTitleBar, SINGLE_WINDOW_PARTS, ZenModeSettings } from '../services/layout/browser/layoutService.js';
+import { ILifecycleService, StartupKind } from '../services/lifecycle/common/lifecycle.js';
 import { IPaneCompositePartService } from '../services/panecomposite/browser/panecomposite.js';
+import { IStatusbarService } from '../services/statusbar/browser/statusbar.js';
+import { ITitleService } from '../services/title/browser/titleService.js';
+import { Part } from './part.js';
 import { AuxiliaryBarPart } from './parts/auxiliarybar/auxiliaryBarPart.js';
-import { ITelemetryService } from '../../platform/telemetry/common/telemetry.js';
-import { IAuxiliaryWindowService } from '../services/auxiliaryWindow/browser/auxiliaryWindowService.js';
+import { PanelPart } from './parts/panel/panelPart.js';
+import { SidebarPart } from './parts/sidebar/sidebarPart.js';
 
 //#region Layout Implementation
 
@@ -300,7 +300,7 @@ export abstract class Layout extends Disposable implements IWorkbenchLayoutServi
 
 	constructor(
 		protected readonly parent: HTMLElement,
-		private readonly layoutOptions?: { resetLayout: boolean }
+		private readonly layoutOptions?: { resetLayout?: boolean; customEditorRestore?: (accessor: ServicesAccessor, defaultLayout: boolean) => Promise<void> }
 	) {
 		super();
 
@@ -893,7 +893,7 @@ export abstract class Layout extends Disposable implements IWorkbenchLayoutServi
 		return this.restored;
 	}
 
-	protected restoreParts(): void {
+	protected restoreParts(instantiationService: IInstantiationService): void {
 
 		// distinguish long running restore operations that
 		// are required for the layout to be ready from those
@@ -957,11 +957,14 @@ export abstract class Layout extends Disposable implements IWorkbenchLayoutServi
 				}));
 			}
 
+			const customEditorRestorePromise = instantiationService.invokeFunction(this.layoutOptions?.customEditorRestore ?? (async () => { }), !!this.state.initialization.layout?.editors);
+
 			// do not block the overall layout ready flow from potentially
 			// slow editors to resolve on startup
 			layoutRestoredPromises.push(
 				Promise.all([
 					openEditorsPromise?.finally(() => mark('code/restoreEditors/editorsOpened')),
+					customEditorRestorePromise?.finally(() => mark('code/restoreEditors/customEditorsOpened')),
 					this.editorGroupService.whenRestored.finally(() => mark('code/restoreEditors/editorGroupsRestored'))
 				]).finally(() => {
 					// the `code/didRestoreEditors` perf mark is specifically
diff --git a/src/vs/workbench/browser/workbench.ts b/src/vs/workbench/browser/workbench.ts
index 57c88e3ab62..4ffb745c9de 100644
--- a/src/vs/workbench/browser/workbench.ts
+++ b/src/vs/workbench/browser/workbench.ts
@@ -15,7 +15,7 @@ import { getSingletonServiceDescriptors } from '../../platform/instantiation/com
 import { Position, Parts, IWorkbenchLayoutService, positionToString } from '../services/layout/browser/layoutService.js';
 import { IStorageService, WillSaveStateReason, StorageScope, StorageTarget } from '../../platform/storage/common/storage.js';
 import { IConfigurationChangeEvent, IConfigurationService } from '../../platform/configuration/common/configuration.js';
-import { IInstantiationService } from '../../platform/instantiation/common/instantiation.js';
+import { IInstantiationService, ServicesAccessor } from '../../platform/instantiation/common/instantiation.js';
 import { ServiceCollection } from '../../platform/instantiation/common/serviceCollection.js';
 import { LifecyclePhase, ILifecycleService, WillShutdownEvent } from '../services/lifecycle/common/lifecycle.js';
 import { INotificationService } from '../../platform/notification/common/notification.js';
@@ -55,6 +55,8 @@ export interface IWorkbenchOptions {
 	 * Whether to reset the workbench parts layout on startup.
 	 */
 	resetLayout?: boolean;
+
+	customEditorRestore?: (accessor: ServicesAccessor, defaultLayout: boolean) => Promise<void>
 }
 
 export class Workbench extends Layout {
@@ -71,7 +73,7 @@ export class Workbench extends Layout {
 		private readonly serviceCollection: ServiceCollection,
 		logService: ILogService
 	) {
-		super(parent, { resetLayout: Boolean(options?.resetLayout) });
+		super(parent, { resetLayout: options?.resetLayout, customEditorRestore: options?.customEditorRestore });
 
 		// Perf: measure workbench startup time
 		mark('code/willStartWorkbench');
@@ -156,7 +158,7 @@ export class Workbench extends Layout {
 				this.layout();
 
 				// Restore
-				this.restore(lifecycleService);
+				this.restore(instantiationService, lifecycleService);
 			});
 
 			return instantiationService;
@@ -384,11 +386,11 @@ export class Workbench extends Layout {
 		});
 	}
 
-	protected restore(lifecycleService: ILifecycleService): void {
+	protected restore(instantiationService: IInstantiationService, lifecycleService: ILifecycleService): void {
 
 		// Ask each part to restore
 		try {
-			this.restoreParts();
+			this.restoreParts(instantiationService);
 		} catch (error) {
 			onUnexpectedError(error);
 		}
