From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lo=C3=AFc=20Mangeonjean?= <loic@coderpad.io>
Date: Tue, 23 Sep 2025 11:13:34 +0200
Subject: [PATCH] feat: add customEditorRestore

---
 src/vs/workbench/browser/layout.ts    | 14 +++++++++-----
 src/vs/workbench/browser/workbench.ts | 12 +++++++-----
 2 files changed, 16 insertions(+), 10 deletions(-)

diff --git a/src/vs/workbench/browser/layout.ts b/src/vs/workbench/browser/layout.ts
index 8bb50e8aac2..5f188521cc4 100644
--- a/src/vs/workbench/browser/layout.ts
+++ b/src/vs/workbench/browser/layout.ts
@@ -41,13 +41,14 @@ import { URI } from '../../base/common/uri.js';
 import { IViewDescriptorService, ViewContainerLocation } from '../common/views.js';
 import { DiffEditorInput } from '../common/editor/diffEditorInput.js';
 import { mark } from '../../base/common/performance.js';
-import { IExtensionService } from '../services/extensions/common/extensions.js';
+import { IInstantiationService } from '../../platform/instantiation/common/instantiation.js';
 import { ILogService } from '../../platform/log/common/log.js';
+import { ITelemetryService } from '../../platform/telemetry/common/telemetry.js';
+import { IAuxiliaryWindowService } from '../services/auxiliaryWindow/browser/auxiliaryWindowService.js';
 import { IBannerService } from '../services/banner/browser/bannerService.js';
+import { IExtensionService } from '../services/extensions/common/extensions.js';
 import { IPaneCompositePartService } from '../services/panecomposite/browser/panecomposite.js';
 import { AuxiliaryBarPart } from './parts/auxiliarybar/auxiliaryBarPart.js';
-import { ITelemetryService } from '../../platform/telemetry/common/telemetry.js';
-import { IAuxiliaryWindowService } from '../services/auxiliaryWindow/browser/auxiliaryWindowService.js';
 
 //#region Layout Implementation
 
@@ -301,7 +302,7 @@ export abstract class Layout extends Disposable implements IWorkbenchLayoutServi
 
 	constructor(
 		protected readonly parent: HTMLElement,
-		private readonly layoutOptions?: { resetLayout: boolean }
+		private readonly layoutOptions?: { resetLayout?: boolean; customEditorRestore?: (accessor: ServicesAccessor, defaultLayout: boolean) => Promise<void> }
 	) {
 		super();
 
@@ -930,7 +931,7 @@ export abstract class Layout extends Disposable implements IWorkbenchLayoutServi
 		return this.restored;
 	}
 
-	protected restoreParts(): void {
+	protected restoreParts(instantiationService: IInstantiationService): void {
 
 		// distinguish long running restore operations that
 		// are required for the layout to be ready from those
@@ -994,11 +995,14 @@ export abstract class Layout extends Disposable implements IWorkbenchLayoutServi
 				}));
 			}
 
+			const customEditorRestorePromise = instantiationService.invokeFunction(this.layoutOptions?.customEditorRestore ?? (async () => { }), !!this.state.initialization.layout?.editors);
+
 			// do not block the overall layout ready flow from potentially
 			// slow editors to resolve on startup
 			layoutRestoredPromises.push(
 				Promise.all([
 					openEditorsPromise?.finally(() => mark('code/restoreEditors/editorsOpened')),
+					customEditorRestorePromise?.finally(() => mark('code/restoreEditors/customEditorsOpened')),
 					this.editorGroupService.whenRestored.finally(() => mark('code/restoreEditors/editorGroupsRestored'))
 				]).finally(() => {
 					// the `code/didRestoreEditors` perf mark is specifically
diff --git a/src/vs/workbench/browser/workbench.ts b/src/vs/workbench/browser/workbench.ts
index 77c83d6dee7..3abdecbb061 100644
--- a/src/vs/workbench/browser/workbench.ts
+++ b/src/vs/workbench/browser/workbench.ts
@@ -15,7 +15,7 @@ import { getSingletonServiceDescriptors } from '../../platform/instantiation/com
 import { Position, Parts, IWorkbenchLayoutService, positionToString } from '../services/layout/browser/layoutService.js';
 import { IStorageService, WillSaveStateReason, StorageScope, StorageTarget } from '../../platform/storage/common/storage.js';
 import { IConfigurationChangeEvent, IConfigurationService } from '../../platform/configuration/common/configuration.js';
-import { IInstantiationService } from '../../platform/instantiation/common/instantiation.js';
+import { IInstantiationService, ServicesAccessor } from '../../platform/instantiation/common/instantiation.js';
 import { ServiceCollection } from '../../platform/instantiation/common/serviceCollection.js';
 import { LifecyclePhase, ILifecycleService, WillShutdownEvent } from '../services/lifecycle/common/lifecycle.js';
 import { INotificationService } from '../../platform/notification/common/notification.js';
@@ -55,6 +55,8 @@ export interface IWorkbenchOptions {
 	 * Whether to reset the workbench parts layout on startup.
 	 */
 	resetLayout?: boolean;
+
+	customEditorRestore?: (accessor: ServicesAccessor, defaultLayout: boolean) => Promise<void>
 }
 
 export class Workbench extends Layout {
@@ -71,7 +73,7 @@ export class Workbench extends Layout {
 		private readonly serviceCollection: ServiceCollection,
 		logService: ILogService
 	) {
-		super(parent, { resetLayout: Boolean(options?.resetLayout) });
+		super(parent, { resetLayout: options?.resetLayout, customEditorRestore: options?.customEditorRestore });
 
 		// Perf: measure workbench startup time
 		mark('code/willStartWorkbench');
@@ -161,7 +163,7 @@ export class Workbench extends Layout {
 				this.layout();
 
 				// Restore
-				this.restore(lifecycleService);
+				this.restore(instantiationService, lifecycleService);
 			});
 
 			return instantiationService;
@@ -389,11 +391,11 @@ export class Workbench extends Layout {
 		});
 	}
 
-	protected restore(lifecycleService: ILifecycleService): void {
+	protected restore(instantiationService: IInstantiationService, lifecycleService: ILifecycleService): void {
 
 		// Ask each part to restore
 		try {
-			this.restoreParts();
+			this.restoreParts(instantiationService);
 		} catch (error) {
 			onUnexpectedError(error);
 		}
