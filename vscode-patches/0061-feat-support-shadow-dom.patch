From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lo=C3=AFc=20Mangeonjean?= <loic@coderpad.io>
Date: Fri, 2 May 2025 10:13:06 +0200
Subject: [PATCH] feat: support shadow dom

---
 src/vs/base/browser/dom.ts                    | 61 ++++++++++++++++---
 src/vs/base/browser/domStylesheets.ts         | 21 +++++--
 src/vs/base/browser/keyboardEvent.ts          | 12 +++-
 .../browser/ui/contextview/contextview.ts     |  2 +-
 src/vs/base/browser/ui/dialog/dialog.ts       |  6 +-
 src/vs/base/browser/ui/dnd/dnd.ts             |  4 +-
 src/vs/base/browser/ui/findinput/findInput.ts |  3 +-
 .../base/browser/ui/findinput/replaceInput.ts |  3 +-
 src/vs/base/browser/ui/inputbox/inputBox.ts   |  2 +-
 src/vs/base/browser/ui/sash/sash.ts           |  2 +-
 src/vs/base/browser/ui/splitview/paneview.ts  |  6 +-
 src/vs/base/browser/ui/splitview/splitview.ts |  6 +-
 .../native/screenReaderContentRich.ts         |  6 +-
 .../native/screenReaderContentSimple.ts       |  6 +-
 .../editor/browser/controller/mouseHandler.ts |  2 +-
 .../editor/browser/controller/mouseTarget.ts  |  2 +-
 src/vs/editor/browser/view/viewPart.ts        |  3 +-
 .../contentWidgets/contentWidgets.ts          |  2 +-
 .../hover/browser/contentHoverController.ts   |  3 +-
 .../hover/browser/contentHoverWidget.ts       |  2 +-
 .../actionWidget/browser/actionList.ts        |  5 +-
 .../clipboard/browser/clipboardService.ts     |  4 +-
 .../contextkey/browser/contextKeyService.ts   | 26 ++++----
 src/vs/platform/hover/browser/hoverWidget.ts  |  2 +-
 .../browser/actions/developerActions.ts       |  4 +-
 src/vs/workbench/browser/layout.ts            |  3 +
 .../browser/parts/editor/editorGroupView.ts   |  4 +-
 src/vs/workbench/browser/workbench.ts         |  6 +-
 .../browser/widget/input/chatInputPart.ts     |  2 +-
 .../files/browser/views/explorerViewer.ts     |  4 +-
 .../notebook/browser/notebookEditorWidget.ts  |  6 +-
 .../browser/view/cellParts/cellStatusPart.ts  |  5 +-
 .../browser/view/cellParts/codeCell.ts        |  6 +-
 .../browser/view/cellParts/markupCell.ts      |  6 +-
 .../notebook/browser/view/notebookCellList.ts |  5 +-
 .../view/renderers/backLayerWebView.ts        |  3 +-
 .../browser/preferences.contribution.ts       |  3 +-
 .../preferences/browser/settingsEditor2.ts    |  6 +-
 .../terminal/browser/terminalTabbedView.ts    |  2 +-
 .../contrib/terminal/browser/terminalView.ts  |  2 +-
 .../contrib/webview/browser/webviewElement.ts | 12 ++--
 .../browser/gettingStarted.ts                 |  4 +-
 .../browser/walkThroughPart.ts                |  6 +-
 .../suggest/browser/simpleSuggestWidget.ts    |  4 +-
 .../themes/browser/workbenchThemeService.ts   |  2 +-
 45 files changed, 187 insertions(+), 99 deletions(-)

diff --git a/src/vs/base/browser/dom.ts b/src/vs/base/browser/dom.ts
index df985c36c16..41fba15d553 100644
--- a/src/vs/base/browser/dom.ts
+++ b/src/vs/base/browser/dom.ts
@@ -257,6 +257,39 @@ export function addDisposableListener(node: EventTarget, type: string, handler:
 	return new DomListener(node, type, handler, useCaptureOrOptions);
 }
 
+export interface IActiveElementTracker extends Disposable {
+	readonly onDidChangeActiveElement: event.Event<Element | null>;
+	activeElement: Element | null;
+}
+
+class ActiveElementTracker extends Disposable implements IActiveElementTracker {
+	activeElement: Element | null = null;
+	private readonly _onDidChangeActiveElement = this._register(new event.Emitter<Element | null>());
+	get onDidChangeActiveElement() { return this._onDidChangeActiveElement.event; }
+
+	constructor(private window: CodeWindow) {
+		super();
+		this._register(addDisposableListener(this.window, EventType.FOCUS_IN, this._onFocusIn));
+	}
+
+	private _onFocusIn = (e: FocusEvent) => {
+		this.activeElement = getActiveElement(this.window.document);
+		this._onDidChangeActiveElement.fire(this.activeElement);
+
+		if (isElement(e.target) && e.target.shadowRoot) {
+			const disposableStore = new DisposableStore();
+			disposableStore.add(addDisposableListener(e.target.shadowRoot, EventType.FOCUS_IN, this._onFocusIn));
+			disposableStore.add(addDisposableListener(e.target, EventType.FOCUS_OUT, () => {
+				disposableStore.dispose();
+			}));
+		}
+	};
+}
+
+export function trackActiveElement(window: CodeWindow): IActiveElementTracker {
+	return new ActiveElementTracker(window);
+}
+
 export interface IAddStandardDisposableListenerSignature {
 	(node: HTMLElement | Element | Document, type: 'click', handler: (event: IMouseEvent) => void, useCapture?: boolean): IDisposable;
 	(node: HTMLElement | Element | Document, type: 'mousedown', handler: (event: IMouseEvent) => void, useCapture?: boolean): IDisposable;
@@ -762,8 +795,7 @@ export function getTopLeftOffset(element: HTMLElement): IDomPosition {
 
 	while (
 		(element = <HTMLElement>element.parentNode) !== null
-		&& element !== element.ownerDocument.body
-		&& element !== element.ownerDocument.documentElement
+		&& element !== element.getRootNode()
 	) {
 		top -= element.scrollTop;
 		const c = isShadowRoot(element) ? null : getComputedStyle(element);
@@ -865,7 +897,7 @@ export function getDomNodeZoomLevel(domNode: HTMLElement): number {
 		}
 
 		testElement = testElement.parentElement;
-	} while (testElement !== null && testElement !== testElement.ownerDocument.documentElement);
+	} while (testElement !== null && testElement !== testElement.getRootNode());
 
 	return zoom;
 }
@@ -943,7 +975,7 @@ function getParentFlowToElement(node: HTMLElement): HTMLElement | null {
 	const flowToParentId = node.dataset[parentFlowToDataKey];
 	if (typeof flowToParentId === 'string') {
 		// eslint-disable-next-line no-restricted-syntax
-		return node.ownerDocument.getElementById(flowToParentId);
+		return (node.getRootNode() as Document | ShadowRoot).getElementById(flowToParentId);
 	}
 	return null;
 }
@@ -1026,8 +1058,8 @@ export function getShadowRoot(domNode: Node): ShadowRoot | null {
  * based on document focus. Falls back to the main
  * window if no window has focus.
  */
-export function getActiveElement(): Element | null {
-	let result = getActiveDocument().activeElement;
+export function getActiveElement(_document = getActiveDocument()): Element | null {
+	let result = _document.activeElement;
 
 	while (result?.shadowRoot) {
 		result = result.shadowRoot.activeElement;
@@ -1036,6 +1068,14 @@ export function getActiveElement(): Element | null {
 	return result;
 }
 
+export function getRootContainer(element: Element) {
+	let container: Node = element.getRootNode();
+	if (container instanceof Document) {
+		container = container.body;
+	}
+	return container;
+}
+
 /**
  * Returns true if the focused window active element matches
  * the provided element. Falls back to the main window if no
@@ -1198,6 +1238,11 @@ export function isHTMLDivElement(e: unknown): e is HTMLDivElement {
 	return e instanceof HTMLDivElement || e instanceof getWindow(e as Node).HTMLDivElement;
 }
 
+export function isHTMLIframeElement(e: unknown): e is HTMLDivElement {
+	// eslint-disable-next-line no-restricted-syntax
+	return e instanceof HTMLIFrameElement || e instanceof getWindow(e as Node).HTMLIFrameElement;
+}
+
 export function isSVGElement(e: unknown): e is SVGElement {
 	// eslint-disable-next-line no-restricted-syntax
 	return e instanceof SVGElement || e instanceof getWindow(e as Node).SVGElement;
@@ -1343,7 +1388,7 @@ class FocusTracker extends Disposable implements IFocusTracker {
 	private static hasFocusWithin(element: HTMLElement | Window): boolean {
 		if (isHTMLElement(element)) {
 			const shadowRoot = getShadowRoot(element);
-			const activeElement = (shadowRoot ? shadowRoot.activeElement : element.ownerDocument.activeElement);
+			const activeElement = (shadowRoot ? shadowRoot.activeElement : (element.getRootNode() as Document | ShadowRoot).activeElement);
 			return isAncestor(activeElement, element);
 		} else {
 			const window = element;
@@ -1563,7 +1608,7 @@ export function removeTabIndexAndUpdateFocus(node: HTMLElement): void {
 	// standard DOM behavior is to move focus to the <body> element. We
 	// typically never want that, rather put focus to the closest element
 	// in the hierarchy of the parent DOM nodes.
-	if (node.ownerDocument.activeElement === node) {
+	if ((node.getRootNode() as Document | ShadowRoot).activeElement === node) {
 		const parentFocusable = findParentWithAttribute(node.parentElement, 'tabIndex');
 		parentFocusable?.focus();
 	}
diff --git a/src/vs/base/browser/domStylesheets.ts b/src/vs/base/browser/domStylesheets.ts
index c338502d541..3da2ba1f9dd 100644
--- a/src/vs/base/browser/domStylesheets.ts
+++ b/src/vs/base/browser/domStylesheets.ts
@@ -39,6 +39,14 @@ class WrappedStyleElement extends Disposable {
 	}
 }
 
+export let shadowRootContainer: ShadowRoot | undefined;
+export function setContainerElement(container: HTMLElement) {
+	const root = container.getRootNode();
+	if (root instanceof ShadowRoot) {
+		shadowRootContainer = root;
+	}
+}
+
 export function createStyleSheet(container: HTMLElement = mainWindow.document.head, beforeAppend?: (style: HTMLStyleElement) => void, disposableStore?: DisposableStore): HTMLStyleElement {
 	const style = document.createElement('style');
 	style.type = 'text/css';
@@ -64,7 +72,12 @@ export function createStyleSheet(container: HTMLElement = mainWindow.document.he
 				continue; // main window is already tracked
 			}
 
-			const cloneDisposable = disposables.add(cloneGlobalStyleSheet(style, globalStylesheetClones, targetWindow));
+			const cloneDisposable = disposables.add(cloneGlobalStyleSheet(style, globalStylesheetClones, targetWindow.document.head));
+			disposableStore?.add(cloneDisposable);
+		}
+
+		if (shadowRootContainer !== undefined) {
+			const cloneDisposable = cloneGlobalStyleSheet(style, globalStylesheetClones, shadowRootContainer);
 			disposableStore?.add(cloneDisposable);
 		}
 	}
@@ -76,17 +89,17 @@ export function cloneGlobalStylesheets(targetWindow: Window): IDisposable {
 	const disposables = new DisposableStore();
 
 	for (const [globalStylesheet, clonedGlobalStylesheets] of globalStylesheets) {
-		disposables.add(cloneGlobalStyleSheet(globalStylesheet, clonedGlobalStylesheets, targetWindow));
+		disposables.add(cloneGlobalStyleSheet(globalStylesheet, clonedGlobalStylesheets, targetWindow.document.head));
 	}
 
 	return disposables;
 }
 
-function cloneGlobalStyleSheet(globalStylesheet: HTMLStyleElement, globalStylesheetClones: Set<HTMLStyleElement>, targetWindow: Window): IDisposable {
+function cloneGlobalStyleSheet(globalStylesheet: HTMLStyleElement, globalStylesheetClones: Set<HTMLStyleElement>, windowElement: HTMLElement | ShadowRoot): IDisposable {
 	const disposables = new DisposableStore();
 
 	const clone = globalStylesheet.cloneNode(true) as HTMLStyleElement;
-	targetWindow.document.head.appendChild(clone);
+	windowElement.appendChild(clone);
 	disposables.add(toDisposable(() => clone.remove()));
 
 	for (const rule of getDynamicStyleSheetRules(globalStylesheet)) {
diff --git a/src/vs/base/browser/keyboardEvent.ts b/src/vs/base/browser/keyboardEvent.ts
index 6b675d06535..672eeabd7b6 100644
--- a/src/vs/base/browser/keyboardEvent.ts
+++ b/src/vs/base/browser/keyboardEvent.ts
@@ -7,6 +7,7 @@ import * as browser from './browser.js';
 import { EVENT_KEY_CODE_MAP, isModifierKey, KeyCode, KeyCodeUtils, KeyMod } from '../common/keyCodes.js';
 import { KeyCodeChord } from '../common/keybindings.js';
 import * as platform from '../common/platform.js';
+import { isHTMLIframeElement } from './dom.js';
 
 function extractKeyCode(e: KeyboardEvent): KeyCode {
 	if (e.charCode) {
@@ -121,6 +122,15 @@ export function hasModifierKeys(keyStatus: {
 	return keyStatus.ctrlKey || keyStatus.shiftKey || keyStatus.altKey || keyStatus.metaKey;
 }
 
+function getTarget(source: KeyboardEvent) {
+	if (isHTMLIframeElement(source.target)) {
+		// If the target is an iframe, we return the iframe element itself because for some reasons, source.composedPath()[0] just returns the main window
+		return source.target;
+	}
+	// composedPath allows to access the real target, even inside a shadow root
+	return <HTMLElement>source.composedPath()[0] ?? source.target;
+}
+
 export class StandardKeyboardEvent implements IKeyboardEvent {
 
 	readonly _standardKeyboardEventBrand = true;
@@ -143,7 +153,7 @@ export class StandardKeyboardEvent implements IKeyboardEvent {
 		const e = source;
 
 		this.browserEvent = e;
-		this.target = <HTMLElement>e.target;
+		this.target = getTarget(e);
 
 		this.ctrlKey = e.ctrlKey;
 		this.shiftKey = e.shiftKey;
diff --git a/src/vs/base/browser/ui/contextview/contextview.ts b/src/vs/base/browser/ui/contextview/contextview.ts
index 44c3c080e24..b56e1cf334e 100644
--- a/src/vs/base/browser/ui/contextview/contextview.ts
+++ b/src/vs/base/browser/ui/contextview/contextview.ts
@@ -383,7 +383,7 @@ export class ContextView extends Disposable {
 	private onDOMEvent(e: UIEvent, onCapture: boolean): void {
 		if (this.delegate) {
 			if (this.delegate.onDOMEvent) {
-				this.delegate.onDOMEvent(e, <HTMLElement>DOM.getWindow(e).document.activeElement);
+				this.delegate.onDOMEvent(e, <HTMLElement>DOM.getActiveElement(DOM.getWindow(e).document));
 			} else if (onCapture && !DOM.isAncestor(<HTMLElement>e.target, this.container)) {
 				this.hide();
 			}
diff --git a/src/vs/base/browser/ui/dialog/dialog.ts b/src/vs/base/browser/ui/dialog/dialog.ts
index 6c972e7866b..4e7872e78ad 100644
--- a/src/vs/base/browser/ui/dialog/dialog.ts
+++ b/src/vs/base/browser/ui/dialog/dialog.ts
@@ -5,7 +5,7 @@
 
 import './dialog.css';
 import { localize } from '../../../../nls.js';
-import { $, addDisposableListener, addStandardDisposableListener, clearNode, EventHelper, EventType, getWindow, hide, isActiveElement, isAncestor, show } from '../../dom.js';
+import { $, addDisposableListener, addStandardDisposableListener, clearNode, EventHelper, EventType, getActiveElement, getWindow, hide, isActiveElement, isAncestor, show } from '../../dom.js';
 import { StandardKeyboardEvent } from '../../keyboardEvent.js';
 import { ActionBar } from '../actionbar/actionbar.js';
 import { ButtonBar, ButtonBarAlignment, ButtonWithDescription, ButtonWithDropdown, IButton, IButtonStyles, IButtonWithDropdownOptions } from '../button/button.js';
@@ -254,7 +254,7 @@ export class Dialog extends Disposable {
 	}
 
 	async show(): Promise<IDialogResult> {
-		this.focusToReturn = this.container.ownerDocument.activeElement as HTMLElement;
+		this.focusToReturn = getActiveElement(this.container.ownerDocument) as HTMLElement;
 
 		return new Promise<IDialogResult>(resolve => {
 			clearNode(this.buttonsContainer);
@@ -599,7 +599,7 @@ export class Dialog extends Disposable {
 			this.modalElement = undefined;
 		}
 
-		if (this.focusToReturn && isAncestor(this.focusToReturn, this.container.ownerDocument.body)) {
+		if (this.focusToReturn && isAncestor(this.focusToReturn, this.container.getRootNode())) {
 			this.focusToReturn.focus();
 			this.focusToReturn = undefined;
 		}
diff --git a/src/vs/base/browser/ui/dnd/dnd.ts b/src/vs/base/browser/ui/dnd/dnd.ts
index 39ce04a13a8..06cdc96e51d 100644
--- a/src/vs/base/browser/ui/dnd/dnd.ts
+++ b/src/vs/base/browser/ui/dnd/dnd.ts
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-import { $ } from '../../dom.js';
+import { $, getRootContainer } from '../../dom.js';
 import './dnd.css';
 
 export function applyDragImage(event: DragEvent, container: HTMLElement, label: string, extraClasses: string[] = []): void {
@@ -19,7 +19,7 @@ export function applyDragImage(event: DragEvent, container: HTMLElement, label:
 		while (e && !e.classList.contains('monaco-workbench')) {
 			e = e.parentElement;
 		}
-		return e || container.ownerDocument.body;
+		return e || getRootContainer(container);
 	};
 
 	const dragContainer = getDragImageContainer(container);
diff --git a/src/vs/base/browser/ui/findinput/findInput.ts b/src/vs/base/browser/ui/findinput/findInput.ts
index 80f9fea1f87..39eef0473c9 100644
--- a/src/vs/base/browser/ui/findinput/findInput.ts
+++ b/src/vs/base/browser/ui/findinput/findInput.ts
@@ -20,6 +20,7 @@ import * as nls from '../../../../nls.js';
 import { DisposableStore, MutableDisposable } from '../../../common/lifecycle.js';
 import { IHistory } from '../../../common/history.js';
 import type { IHoverLifecycleOptions } from '../hover/hover.js';
+import { getActiveElement } from '../../dom.js';
 
 
 export interface IFindInputOptions {
@@ -177,7 +178,7 @@ export class FindInput extends Widget {
 			const indexes = [this.caseSensitive.domNode, this.wholeWords.domNode, this.regex.domNode];
 			this.onkeydown(this.domNode, (event: IKeyboardEvent) => {
 				if (event.equals(KeyCode.LeftArrow) || event.equals(KeyCode.RightArrow) || event.equals(KeyCode.Escape)) {
-					const index = indexes.indexOf(<HTMLElement>this.domNode.ownerDocument.activeElement);
+					const index = indexes.indexOf(<HTMLElement>getActiveElement(this.domNode.ownerDocument));
 					if (index >= 0) {
 						let newIndex: number = -1;
 						if (event.equals(KeyCode.RightArrow)) {
diff --git a/src/vs/base/browser/ui/findinput/replaceInput.ts b/src/vs/base/browser/ui/findinput/replaceInput.ts
index 10c5b47b653..6dd9e205c71 100644
--- a/src/vs/base/browser/ui/findinput/replaceInput.ts
+++ b/src/vs/base/browser/ui/findinput/replaceInput.ts
@@ -18,6 +18,7 @@ import './findInput.css';
 import * as nls from '../../../../nls.js';
 import { IHistory } from '../../../common/history.js';
 import { type IHoverLifecycleOptions } from '../hover/hover.js';
+import { getActiveElement } from '../../dom.js';
 
 
 export interface IReplaceInputOptions {
@@ -145,7 +146,7 @@ export class ReplaceInput extends Widget {
 		const indexes = [this.preserveCase.domNode];
 		this.onkeydown(this.domNode, (event: IKeyboardEvent) => {
 			if (event.equals(KeyCode.LeftArrow) || event.equals(KeyCode.RightArrow) || event.equals(KeyCode.Escape)) {
-				const index = indexes.indexOf(<HTMLElement>this.domNode.ownerDocument.activeElement);
+				const index = indexes.indexOf(<HTMLElement>getActiveElement(this.domNode.ownerDocument));
 				if (index >= 0) {
 					let newIndex: number = -1;
 					if (event.equals(KeyCode.RightArrow)) {
diff --git a/src/vs/base/browser/ui/inputbox/inputBox.ts b/src/vs/base/browser/ui/inputbox/inputBox.ts
index 9b55cd2ec68..a7606504872 100644
--- a/src/vs/base/browser/ui/inputbox/inputBox.ts
+++ b/src/vs/base/browser/ui/inputbox/inputBox.ts
@@ -174,7 +174,7 @@ export class InputBox extends Widget {
 
 			const onSelectionChange = this._register(new DomEmitter(container.ownerDocument, 'selectionchange'));
 			const onAnchoredSelectionChange = Event.filter(onSelectionChange.event, () => {
-				const selection = container.ownerDocument.getSelection();
+				const selection = (container.getRootNode() as Document).getSelection();
 				return selection?.anchorNode === wrapper;
 			});
 
diff --git a/src/vs/base/browser/ui/sash/sash.ts b/src/vs/base/browser/ui/sash/sash.ts
index 6f2fcb52276..0f9594a7d77 100644
--- a/src/vs/base/browser/ui/sash/sash.ts
+++ b/src/vs/base/browser/ui/sash/sash.ts
@@ -512,7 +512,7 @@ export class Sash extends Disposable {
 		}
 
 		// eslint-disable-next-line no-restricted-syntax
-		const iframes = this.el.ownerDocument.getElementsByTagName('iframe');
+		const iframes = (this.el.getRootNode() as Document | ShadowRoot).querySelectorAll('iframe');
 		for (const iframe of iframes) {
 			iframe.classList.add(PointerEventsDisabledCssClass); // disable mouse events on iframes as long as we drag the sash
 		}
diff --git a/src/vs/base/browser/ui/splitview/paneview.ts b/src/vs/base/browser/ui/splitview/paneview.ts
index fb2e1f406ae..6a3a3d9b045 100644
--- a/src/vs/base/browser/ui/splitview/paneview.ts
+++ b/src/vs/base/browser/ui/splitview/paneview.ts
@@ -5,7 +5,7 @@
 
 import { isFirefox } from '../../browser.js';
 import { DataTransfers } from '../../dnd.js';
-import { $, addDisposableListener, append, clearNode, EventHelper, EventType, getWindow, isHTMLElement, trackFocus } from '../../dom.js';
+import { $, addDisposableListener, append, clearNode, EventHelper, EventType, getActiveElement, getWindow, isHTMLElement, trackFocus } from '../../dom.js';
 import { DomEmitter } from '../../event.js';
 import { StandardKeyboardEvent } from '../../keyboardEvent.js';
 import { Gesture, EventType as TouchEventType } from '../../touch.js';
@@ -663,7 +663,7 @@ export class PaneView extends Disposable {
 
 	private focusPrevious(): void {
 		const headers = this.getPaneHeaderElements();
-		const index = headers.indexOf(this.element.ownerDocument.activeElement as HTMLElement);
+		const index = headers.indexOf(getActiveElement(this.element.ownerDocument) as HTMLElement);
 
 		if (index === -1) {
 			return;
@@ -674,7 +674,7 @@ export class PaneView extends Disposable {
 
 	private focusNext(): void {
 		const headers = this.getPaneHeaderElements();
-		const index = headers.indexOf(this.element.ownerDocument.activeElement as HTMLElement);
+		const index = headers.indexOf(getActiveElement(this.element.ownerDocument) as HTMLElement);
 
 		if (index === -1) {
 			return;
diff --git a/src/vs/base/browser/ui/splitview/splitview.ts b/src/vs/base/browser/ui/splitview/splitview.ts
index 35f2724c1a8..0da8fa62431 100644
--- a/src/vs/base/browser/ui/splitview/splitview.ts
+++ b/src/vs/base/browser/ui/splitview/splitview.ts
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-import { $, addDisposableListener, append, getWindow, scheduleAtNextAnimationFrame } from '../../dom.js';
+import { $, addDisposableListener, append, getRootContainer, getWindow, scheduleAtNextAnimationFrame } from '../../dom.js';
 import { DomEmitter } from '../../event.js';
 import { ISashEvent as IBaseSashEvent, Orientation, Sash, SashState } from '../sash/sash.js';
 import { SmoothScrollableElement } from '../scrollbar/scrollableElement.js';
@@ -892,8 +892,8 @@ export class SplitView<TLayoutContext = undefined, TView extends IView<TLayoutCo
 
 		// This way, we can press Alt while we resize a sash, macOS style!
 		const disposable = combinedDisposable(
-			addDisposableListener(this.el.ownerDocument.body, 'keydown', e => resetSashDragState(this.sashDragState!.current, e.altKey)),
-			addDisposableListener(this.el.ownerDocument.body, 'keyup', () => resetSashDragState(this.sashDragState!.current, false))
+			addDisposableListener(getRootContainer(this.el), 'keydown', e => resetSashDragState(this.sashDragState!.current, e.altKey)),
+			addDisposableListener(getRootContainer(this.el), 'keyup', () => resetSashDragState(this.sashDragState!.current, false))
 		);
 
 		const resetSashDragState = (start: number, alt: boolean) => {
diff --git a/src/vs/editor/browser/controller/editContext/native/screenReaderContentRich.ts b/src/vs/editor/browser/controller/editContext/native/screenReaderContentRich.ts
index 7a274e27f3b..301af699ade 100644
--- a/src/vs/editor/browser/controller/editContext/native/screenReaderContentRich.ts
+++ b/src/vs/editor/browser/controller/editContext/native/screenReaderContentRich.ts
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-import { addDisposableListener, getActiveWindow, isHTMLElement } from '../../../../../base/browser/dom.js';
+import { addDisposableListener, getActiveElement, getActiveWindow, isHTMLElement } from '../../../../../base/browser/dom.js';
 import { FastDomNode } from '../../../../../base/browser/fastDomNode.js';
 import { createTrustedTypesPolicy } from '../../../../../base/browser/trustedTypes.js';
 import { IAccessibilityService } from '../../../../../platform/accessibility/common/accessibility.js';
@@ -50,7 +50,7 @@ export class RichScreenReaderContent extends Disposable implements IScreenReader
 	}
 
 	public updateScreenReaderContent(primarySelection: Selection): void {
-		const focusedElement = getActiveWindow().document.activeElement;
+		const focusedElement = getActiveElement();
 		if (!focusedElement || focusedElement !== this._domNode.domNode) {
 			return;
 		}
@@ -119,7 +119,7 @@ export class RichScreenReaderContent extends Disposable implements IScreenReader
 		// so throttle multiple `selectionchange` events that burst in a short period of time.
 		let previousSelectionChangeEventTime = 0;
 		return addDisposableListener(this._domNode.domNode.ownerDocument, 'selectionchange', () => {
-			const activeElement = getActiveWindow().document.activeElement;
+			const activeElement = getActiveElement();
 			const isFocused = activeElement === this._domNode.domNode;
 			if (!isFocused) {
 				return;
diff --git a/src/vs/editor/browser/controller/editContext/native/screenReaderContentSimple.ts b/src/vs/editor/browser/controller/editContext/native/screenReaderContentSimple.ts
index 308d252fcf7..24cf7baaff5 100644
--- a/src/vs/editor/browser/controller/editContext/native/screenReaderContentSimple.ts
+++ b/src/vs/editor/browser/controller/editContext/native/screenReaderContentSimple.ts
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-import { addDisposableListener, getActiveWindow } from '../../../../../base/browser/dom.js';
+import { addDisposableListener, getActiveElement, getActiveWindow } from '../../../../../base/browser/dom.js';
 import { FastDomNode } from '../../../../../base/browser/fastDomNode.js';
 import { AccessibilitySupport, IAccessibilityService } from '../../../../../platform/accessibility/common/accessibility.js';
 import { EditorOption, IComputedEditorOptions } from '../../../../common/config/editorOptions.js';
@@ -39,7 +39,7 @@ export class SimpleScreenReaderContent extends Disposable implements IScreenRead
 
 	public updateScreenReaderContent(primarySelection: Selection): void {
 		const domNode = this._domNode.domNode;
-		const focusedElement = getActiveWindow().document.activeElement;
+		const focusedElement = getActiveElement();
 		if (!focusedElement || focusedElement !== domNode) {
 			return;
 		}
@@ -122,7 +122,7 @@ export class SimpleScreenReaderContent extends Disposable implements IScreenRead
 			if (!this._state || !isScreenReaderOptimized || !IME.enabled) {
 				return;
 			}
-			const activeElement = getActiveWindow().document.activeElement;
+			const activeElement = getActiveElement();
 			const isFocused = activeElement === this._domNode.domNode;
 			if (!isFocused) {
 				return;
diff --git a/src/vs/editor/browser/controller/mouseHandler.ts b/src/vs/editor/browser/controller/mouseHandler.ts
index 4ad4ca9d817..8f3b1c77524 100644
--- a/src/vs/editor/browser/controller/mouseHandler.ts
+++ b/src/vs/editor/browser/controller/mouseHandler.ts
@@ -102,7 +102,7 @@ export class MouseHandler extends ViewEventHandler {
 			// remove this listener
 
 			if (!this._mouseLeaveMonitor) {
-				this._mouseLeaveMonitor = dom.addDisposableListener(this.viewHelper.viewDomNode.ownerDocument, 'mousemove', (e) => {
+				this._mouseLeaveMonitor = dom.addDisposableListener(this.viewHelper.viewDomNode.getRootNode(), 'mousemove', (e) => {
 					if (!this.viewHelper.viewDomNode.contains(e.target as Node | null)) {
 						// went outside the editor!
 						this._onMouseLeave(new EditorMouseEvent(e, false, this.viewHelper.viewDomNode));
diff --git a/src/vs/editor/browser/controller/mouseTarget.ts b/src/vs/editor/browser/controller/mouseTarget.ts
index 8256f6b487c..6bc03be79e1 100644
--- a/src/vs/editor/browser/controller/mouseTarget.ts
+++ b/src/vs/editor/browser/controller/mouseTarget.ts
@@ -351,7 +351,7 @@ export class HitTestContext {
 	}
 
 	private static _findAttribute(element: Element, attr: string, stopAt: Element): string | null {
-		while (element && element !== element.ownerDocument.body) {
+		while (element && element !== dom.getRootContainer(element)) {
 			if (element.hasAttribute && element.hasAttribute(attr)) {
 				return element.getAttribute(attr);
 			}
diff --git a/src/vs/editor/browser/view/viewPart.ts b/src/vs/editor/browser/view/viewPart.ts
index 1009c8e7ca0..bf02d491fd3 100644
--- a/src/vs/editor/browser/view/viewPart.ts
+++ b/src/vs/editor/browser/view/viewPart.ts
@@ -8,6 +8,7 @@ import { RenderingContext, RestrictedRenderingContext } from './renderingContext
 import { ViewContext } from '../../common/viewModel/viewContext.js';
 import { ViewEventHandler } from '../../common/viewEventHandler.js';
 import { ViewportData } from '../../common/viewLayout/viewLinesViewportData.js';
+import { getRootContainer } from '../../../base/browser/dom.js';
 
 export abstract class ViewPart extends ViewEventHandler {
 
@@ -63,7 +64,7 @@ export class PartFingerprints {
 		const result: PartFingerprint[] = [];
 		let resultLen = 0;
 
-		while (child && child !== child.ownerDocument.body) {
+		while (child && child !== getRootContainer(child)) {
 			if (child === stopAt) {
 				break;
 			}
diff --git a/src/vs/editor/browser/viewParts/contentWidgets/contentWidgets.ts b/src/vs/editor/browser/viewParts/contentWidgets/contentWidgets.ts
index 1f43f7834f0..550be23f481 100644
--- a/src/vs/editor/browser/viewParts/contentWidgets/contentWidgets.ts
+++ b/src/vs/editor/browser/viewParts/contentWidgets/contentWidgets.ts
@@ -453,7 +453,7 @@ class Widget {
 		if (!primary) {
 			return {
 				kind: 'offViewport',
-				preserveFocus: this.domNode.domNode.contains(this.domNode.domNode.ownerDocument.activeElement)
+				preserveFocus: this.domNode.domNode.contains(dom.getActiveElement(this.domNode.domNode.ownerDocument))
 			};
 			// return null;
 		}
diff --git a/src/vs/editor/contrib/hover/browser/contentHoverController.ts b/src/vs/editor/contrib/hover/browser/contentHoverController.ts
index ba0e7d0b161..5a4426465a5 100644
--- a/src/vs/editor/contrib/hover/browser/contentHoverController.ts
+++ b/src/vs/editor/contrib/hover/browser/contentHoverController.ts
@@ -24,6 +24,7 @@ import { Emitter } from '../../../../base/common/event.js';
 import { isOnColorDecorator } from '../../colorPicker/browser/hoverColorPicker/hoverColorPicker.js';
 import { isModifierKey, KeyCode } from '../../../../base/common/keyCodes.js';
 import { IContextMenuService } from '../../../../platform/contextview/browser/contextView.js';
+import { getActiveElement } from '../../../../base/browser/dom.js';
 
 // sticky hover widget which doesn't disappear on focus out and such
 const _sticky = false
@@ -205,7 +206,7 @@ export class ContentHoverController extends Disposable implements IEditorContrib
 			if (!view) {
 				return false;
 			}
-			return sticky && contentWidget.containsNode(view.document.activeElement) && !view.getSelection()?.isCollapsed;
+			return sticky && contentWidget.containsNode(getActiveElement(view.document)) && !view.getSelection()?.isCollapsed;
 		};
 		const isFocused = contentWidget.isFocused;
 		const isResizing = contentWidget.isResizing;
diff --git a/src/vs/editor/contrib/hover/browser/contentHoverWidget.ts b/src/vs/editor/contrib/hover/browser/contentHoverWidget.ts
index c5226cb273f..08f5ace9b37 100644
--- a/src/vs/editor/contrib/hover/browser/contentHoverWidget.ts
+++ b/src/vs/editor/contrib/hover/browser/contentHoverWidget.ts
@@ -350,7 +350,7 @@ export class ContentHoverWidget extends ResizableContentWidget {
 		}
 		this._onDidResize.fire();
 		// The aria label overrides the label, so if we add to it, add the contents of the hover
-		const hoverFocused = this._hover.containerDomNode.ownerDocument.activeElement === this._hover.containerDomNode;
+		const hoverFocused = dom.getActiveElement(this._hover.containerDomNode.ownerDocument) === this._hover.containerDomNode;
 		const accessibleViewHint = hoverFocused && getHoverAccessibleViewHint(
 			this._configurationService.getValue('accessibility.verbosity.hover') === true && this._accessibilityService.isScreenReaderOptimized(),
 			this._keybindingService.lookupKeybinding('editor.action.accessibleView')?.getAriaLabel() ?? ''
diff --git a/src/vs/platform/actionWidget/browser/actionList.ts b/src/vs/platform/actionWidget/browser/actionList.ts
index 3c12b59418e..b8d48462193 100644
--- a/src/vs/platform/actionWidget/browser/actionList.ts
+++ b/src/vs/platform/actionWidget/browser/actionList.ts
@@ -460,8 +460,11 @@ export class ActionList<T> extends Disposable {
 	}
 
 	private _getRowElement(index: number): HTMLElement | null {
+		if (this.domNode.isConnected) {
+			return null;
+		}
 		// eslint-disable-next-line no-restricted-syntax
-		return this.domNode.ownerDocument.getElementById(this._list.getElementID(index));
+		return (this.domNode.getRootNode() as Document | ShadowRoot).getElementById(this._list.getElementID(index));
 	}
 
 	private _showHoverForElement(element: IActionListItem<T>, index: number): void {
diff --git a/src/vs/platform/clipboard/browser/clipboardService.ts b/src/vs/platform/clipboard/browser/clipboardService.ts
index 6e0a6e018d0..358aa682cda 100644
--- a/src/vs/platform/clipboard/browser/clipboardService.ts
+++ b/src/vs/platform/clipboard/browser/clipboardService.ts
@@ -4,7 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 
 import { isSafari, isWebkitWebView } from '../../../base/browser/browser.js';
-import { $, addDisposableListener, getActiveDocument, getActiveWindow, isHTMLElement, onDidRegisterWindow } from '../../../base/browser/dom.js';
+import { $, addDisposableListener, getActiveDocument, getActiveElement, getActiveWindow, isHTMLElement, onDidRegisterWindow } from '../../../base/browser/dom.js';
 import { mainWindow } from '../../../base/browser/window.js';
 import { DeferredPromise } from '../../../base/common/async.js';
 import { Event } from '../../../base/common/event.js';
@@ -155,7 +155,7 @@ export class BrowserClipboardService extends Disposable implements IClipboardSer
 	private fallbackWriteText(text: string): void {
 		this.logService.trace('BrowserClipboardService#fallbackWriteText');
 		const activeDocument = getActiveDocument();
-		const activeElement = activeDocument.activeElement;
+		const activeElement = getActiveElement();
 
 		const textArea: HTMLTextAreaElement = activeDocument.body.appendChild($('textarea', { 'aria-hidden': true }));
 		textArea.style.height = '1px';
diff --git a/src/vs/platform/contextkey/browser/contextKeyService.ts b/src/vs/platform/contextkey/browser/contextKeyService.ts
index df8da89a047..0f9fca69091 100644
--- a/src/vs/platform/contextkey/browser/contextKeyService.ts
+++ b/src/vs/platform/contextkey/browser/contextKeyService.ts
@@ -3,6 +3,8 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
+import { getActiveDocument, getActiveElement, isEditableElement, onDidRegisterWindow, trackActiveElement, trackFocus } from '../../../base/browser/dom.js';
+import { mainWindow } from '../../../base/browser/window.js';
 import { Emitter, Event, PauseableEmitter } from '../../../base/common/event.js';
 import { Iterable } from '../../../base/common/iterator.js';
 import { Disposable, DisposableStore, IDisposable, MutableDisposable } from '../../../base/common/lifecycle.js';
@@ -14,11 +16,9 @@ import { URI } from '../../../base/common/uri.js';
 import { localize } from '../../../nls.js';
 import { CommandsRegistry } from '../../commands/common/commands.js';
 import { ConfigurationTarget, IConfigurationService } from '../../configuration/common/configuration.js';
-import { ContextKeyExpression, ContextKeyInfo, ContextKeyValue, IContext, IContextKey, IContextKeyChangeEvent, IContextKeyService, IContextKeyServiceTarget, IReadableSet, IScopedContextKeyService, RawContextKey } from '../common/contextkey.js';
 import { ServicesAccessor } from '../../instantiation/common/instantiation.js';
+import { ContextKeyExpression, ContextKeyInfo, ContextKeyValue, IContext, IContextKey, IContextKeyChangeEvent, IContextKeyService, IContextKeyServiceTarget, IReadableSet, IScopedContextKeyService, RawContextKey } from '../common/contextkey.js';
 import { InputFocusedContext } from '../common/contextkeys.js';
-import { mainWindow } from '../../../base/browser/window.js';
-import { addDisposableListener, EventType, getActiveWindow, isEditableElement, onDidRegisterWindow, trackFocus } from '../../../base/browser/dom.js';
 
 const KEYBINDING_CONTEXT_ATTR = 'data-keybinding-context';
 
@@ -404,24 +404,26 @@ export class ContextKeyService extends AbstractContextKeyService implements ICon
 
 		this._register(Event.runAndSubscribe(onDidRegisterWindow, ({ window, disposables }) => {
 			const onFocusDisposables = disposables.add(new MutableDisposable<DisposableStore>());
-			disposables.add(addDisposableListener(window, EventType.FOCUS_IN, () => {
+
+			const activeElementTracker = disposables.add(trackActiveElement(window));
+			activeElementTracker.onDidChangeActiveElement((activeElement) => {
 				onFocusDisposables.value = new DisposableStore();
-				this.updateInputContextKeys(window.document, onFocusDisposables.value);
-			}, true));
+				this.updateInputContextKeys(window.document, activeElement, onFocusDisposables.value);
+			});
 		}, { window: mainWindow, disposables: this._store }));
 	}
 
-	private updateInputContextKeys(ownerDocument: Document, disposables: DisposableStore): void {
+	private updateInputContextKeys(ownerDocument: Document, activeElement: Element | null, disposables: DisposableStore): void {
 
-		function activeElementIsInput(): boolean {
-			return !!ownerDocument.activeElement && isEditableElement(ownerDocument.activeElement);
+		function activeElementIsInput(activeElement: Element | null = getActiveElement(ownerDocument)): boolean {
+			return !!activeElement && isEditableElement(activeElement);
 		}
 
-		const isInputFocused = activeElementIsInput();
+		const isInputFocused = activeElementIsInput(activeElement);
 		this.inputFocusedContext.set(isInputFocused);
 
 		if (isInputFocused) {
-			const tracker = disposables.add(trackFocus(ownerDocument.activeElement as HTMLElement));
+			const tracker = disposables.add(trackFocus(activeElement as HTMLElement));
 			Event.once(tracker.onDidBlur)(() => {
 
 				// Ensure we are only updating the context key if we are
@@ -432,7 +434,7 @@ export class ContextKeyService extends AbstractContextKeyService implements ICon
 				// blur events from the focus tracker are emitted with a
 				// timeout of 0.
 
-				if (getActiveWindow().document === ownerDocument) {
+				if (getActiveDocument() === ownerDocument) {
 					this.inputFocusedContext.set(activeElementIsInput());
 				}
 
diff --git a/src/vs/platform/hover/browser/hoverWidget.ts b/src/vs/platform/hover/browser/hoverWidget.ts
index 41c8723608a..96297b1ddb8 100644
--- a/src/vs/platform/hover/browser/hoverWidget.ts
+++ b/src/vs/platform/hover/browser/hoverWidget.ts
@@ -326,7 +326,7 @@ export class HoverWidget extends Widget implements IHoverWidget {
 
 	public render(container: HTMLElement): void {
 		container.appendChild(this._hoverContainer);
-		const hoverFocused = this._hoverContainer.contains(this._hoverContainer.ownerDocument.activeElement);
+		const hoverFocused = this._hoverContainer.contains(dom.getActiveElement(this._hoverContainer.ownerDocument));
 		const accessibleViewHint = hoverFocused && getHoverAccessibleViewHint(this._configurationService.getValue('accessibility.verbosity.hover') === true && this._accessibilityService.isScreenReaderOptimized(), this._keybindingService.lookupKeybinding('editor.action.accessibleView')?.getAriaLabel());
 		if (accessibleViewHint) {
 
diff --git a/src/vs/workbench/browser/actions/developerActions.ts b/src/vs/workbench/browser/actions/developerActions.ts
index 91f52f5d2c5..ca0140e4fb3 100644
--- a/src/vs/workbench/browser/actions/developerActions.ts
+++ b/src/vs/workbench/browser/actions/developerActions.ts
@@ -78,7 +78,7 @@ class InspectContextKeysAction extends Action2 {
 
 		const onMouseMove = disposables.add(new DomEmitter(activeDocument, 'mousemove', true));
 		disposables.add(onMouseMove.event(e => {
-			const target = e.target as HTMLElement;
+			const target = e.composedPath()[0] as HTMLElement;
 			const position = getDomNodePagePosition(target);
 
 			hoverFeedback.style.top = `${position.top}px`;
@@ -95,7 +95,7 @@ class InspectContextKeysAction extends Action2 {
 			e.preventDefault();
 			e.stopPropagation();
 
-			const context = contextKeyService.getContext(e.target as HTMLElement) as Context;
+			const context = contextKeyService.getContext(e.composedPath()[0] as HTMLElement) as Context;
 			console.log(context.collectAllValues());
 
 			dispose(disposables);
diff --git a/src/vs/workbench/browser/layout.ts b/src/vs/workbench/browser/layout.ts
index a60b399fcf1..c622d53ae07 100644
--- a/src/vs/workbench/browser/layout.ts
+++ b/src/vs/workbench/browser/layout.ts
@@ -47,6 +47,7 @@ import { AuxiliaryBarPart } from './parts/auxiliarybar/auxiliaryBarPart.js';
 import { ITelemetryService } from '../../platform/telemetry/common/telemetry.js';
 import { IAuxiliaryWindowService } from '../services/auxiliaryWindow/browser/auxiliaryWindowService.js';
 import { CodeWindow, mainWindow } from '../../base/browser/window.js';
+import { setContainerElement } from '../../base/browser/domStylesheets.js';
 
 //#region Layout Implementation
 
@@ -303,6 +304,8 @@ export abstract class Layout extends Disposable implements IWorkbenchLayoutServi
 		private readonly layoutOptions?: { resetLayout: boolean }
 	) {
 		super();
+
+		setContainerElement(parent);
 	}
 
 	protected initLayout(accessor: ServicesAccessor): void {
diff --git a/src/vs/workbench/browser/parts/editor/editorGroupView.ts b/src/vs/workbench/browser/parts/editor/editorGroupView.ts
index a2344eaf8f2..69f87e30afa 100644
--- a/src/vs/workbench/browser/parts/editor/editorGroupView.ts
+++ b/src/vs/workbench/browser/parts/editor/editorGroupView.ts
@@ -11,7 +11,7 @@ import { EditorInput } from '../../../common/editor/editorInput.js';
 import { SideBySideEditorInput } from '../../../common/editor/sideBySideEditorInput.js';
 import { Emitter, Event, Relay } from '../../../../base/common/event.js';
 import { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';
-import { Dimension, trackFocus, addDisposableListener, EventType, EventHelper, findParentWithClass, isAncestor, IDomNodePagePosition, isMouseEvent, isActiveElement, getWindow, getActiveElement, $ } from '../../../../base/browser/dom.js';
+import { Dimension, trackFocus, addDisposableListener, EventType, EventHelper, findParentWithClass, isAncestor, IDomNodePagePosition, isMouseEvent, isActiveElement, getWindow, getActiveElement, $, getRootContainer } from '../../../../base/browser/dom.js';
 import { ServiceCollection } from '../../../../platform/instantiation/common/serviceCollection.js';
 import { IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';
 import { ProgressBar } from '../../../../base/browser/ui/progressbar/progressbar.js';
@@ -1652,7 +1652,7 @@ export class EditorGroupView extends Themable implements IEditorGroupView {
 
 	private shouldRestoreFocus(target: Element): boolean {
 		const activeElement = getActiveElement();
-		if (activeElement === target.ownerDocument.body) {
+		if (activeElement === getRootContainer(target)) {
 			return true; // always restore focus if nothing is focused currently
 		}
 
diff --git a/src/vs/workbench/browser/workbench.ts b/src/vs/workbench/browser/workbench.ts
index 7796aae8a15..1c304a11a9e 100644
--- a/src/vs/workbench/browser/workbench.ts
+++ b/src/vs/workbench/browser/workbench.ts
@@ -77,6 +77,9 @@ export class Workbench extends Layout {
 		mark('code/willStartWorkbench');
 
 		this.registerErrorHandler(logService);
+
+		// Add Workbench to DOM
+		this.parent.appendChild(this.mainContainer);
 	}
 
 	protected registerErrorHandler(logService: ILogService): void {
@@ -342,9 +345,6 @@ export class Workbench extends Layout {
 
 		// Notification Handlers
 		this.createNotificationsHandlers(instantiationService, notificationService);
-
-		// Add Workbench to DOM
-		this.parent.appendChild(this.mainContainer);
 	}
 
 	private createPart(id: string, role: string, classes: string[]): HTMLElement {
diff --git a/src/vs/workbench/contrib/chat/browser/widget/input/chatInputPart.ts b/src/vs/workbench/contrib/chat/browser/widget/input/chatInputPart.ts
index bcf805169da..2447a3ba087 100644
--- a/src/vs/workbench/contrib/chat/browser/widget/input/chatInputPart.ts
+++ b/src/vs/workbench/contrib/chat/browser/widget/input/chatInputPart.ts
@@ -2349,7 +2349,7 @@ export class ChatInputPart extends Disposable implements IHistoryNavigationWidge
 
 		attachments.unshift(toolbar);
 
-		const activeElement = dom.getWindow(this.attachmentsContainer).document.activeElement;
+		const activeElement = dom.getActiveElement(dom.getWindow(this.attachmentsContainer).document);
 		const currentIndex = attachments.findIndex(attachment => attachment === activeElement);
 		let newIndex = currentIndex;
 
diff --git a/src/vs/workbench/contrib/files/browser/views/explorerViewer.ts b/src/vs/workbench/contrib/files/browser/views/explorerViewer.ts
index a4a00dfa7ea..eb13a68974f 100644
--- a/src/vs/workbench/contrib/files/browser/views/explorerViewer.ts
+++ b/src/vs/workbench/contrib/files/browser/views/explorerViewer.ts
@@ -74,6 +74,7 @@ import { IContextKey, IContextKeyService } from '../../../../../platform/context
 import { CountBadge } from '../../../../../base/browser/ui/countBadge/countBadge.js';
 import { listFilterMatchHighlight, listFilterMatchHighlightBorder } from '../../../../../platform/theme/common/colorRegistry.js';
 import { asCssVariable } from '../../../../../platform/theme/common/colorUtils.js';
+import { getActiveElement } from '../../../../../base/browser/dom.js';
 
 export class ExplorerDelegate implements IListVirtualDelegate<ExplorerItem> {
 
@@ -1146,11 +1147,12 @@ export class FilesRenderer implements ICompressibleTreeRenderer<ExplorerItem, Fu
 					await timeout(0);
 
 					const ownerDocument = inputBox.inputElement.ownerDocument;
+					const activeElement = getActiveElement(ownerDocument);
 					if (!ownerDocument.hasFocus()) {
 						break;
 					} if (DOM.isActiveElement(inputBox.inputElement)) {
 						return;
-					} else if (DOM.isHTMLElement(ownerDocument.activeElement) && DOM.hasParentWithClass(ownerDocument.activeElement, 'context-view')) {
+					} else if (DOM.isHTMLElement(activeElement) && DOM.hasParentWithClass(activeElement, 'context-view')) {
 						await Event.toPromise(this.contextMenuService.onDidHideContextMenu);
 					} else {
 						break;
diff --git a/src/vs/workbench/contrib/notebook/browser/notebookEditorWidget.ts b/src/vs/workbench/contrib/notebook/browser/notebookEditorWidget.ts
index 5b21ceec1d3..2419dc30101 100644
--- a/src/vs/workbench/contrib/notebook/browser/notebookEditorWidget.ts
+++ b/src/vs/workbench/contrib/notebook/browser/notebookEditorWidget.ts
@@ -1848,7 +1848,7 @@ export class NotebookEditorWidget extends Disposable implements INotebookEditorD
 				const element = this.viewModel.cellAt(focusRange.start);
 				if (element) {
 					const itemDOM = this._list.domElementOfElement(element);
-					const editorFocused = element.getEditState() === CellEditState.Editing && !!(itemDOM && itemDOM.ownerDocument.activeElement && itemDOM.contains(itemDOM.ownerDocument.activeElement));
+					const editorFocused = element.getEditState() === CellEditState.Editing && !!(itemDOM && DOM.getActiveElement(itemDOM.ownerDocument) && itemDOM.contains(DOM.getActiveElement(itemDOM.ownerDocument)));
 
 					state.editorFocused = editorFocused;
 					state.focus = focusRange.start;
@@ -2480,8 +2480,8 @@ export class NotebookEditorWidget extends Disposable implements INotebookEditorD
 		} else {
 			// focus container
 			const itemDOM = this._list.domElementOfElement(cell);
-			if (itemDOM && itemDOM.ownerDocument.activeElement && itemDOM.contains(itemDOM.ownerDocument.activeElement)) {
-				(itemDOM.ownerDocument.activeElement as HTMLElement).blur();
+			if (itemDOM && DOM.getActiveElement(itemDOM.ownerDocument) && itemDOM.contains(DOM.getActiveElement(itemDOM.ownerDocument))) {
+				(DOM.getActiveElement(itemDOM.ownerDocument) as HTMLElement).blur();
 			}
 
 			this._webview?.blurOutput();
diff --git a/src/vs/workbench/contrib/notebook/browser/view/cellParts/cellStatusPart.ts b/src/vs/workbench/contrib/notebook/browser/view/cellParts/cellStatusPart.ts
index a23d2f8b28e..3f9739cf607 100644
--- a/src/vs/workbench/contrib/notebook/browser/view/cellParts/cellStatusPart.ts
+++ b/src/vs/workbench/contrib/notebook/browser/view/cellParts/cellStatusPart.ts
@@ -146,7 +146,7 @@ export class CellEditorStatusBar extends CellContentPart {
 		if (this._editor) {
 			// Focus Mode
 			const updateFocusModeForEditorEvent = () => {
-				if (this._editor && (this._editor.hasWidgetFocus() || (this.statusBarContainer.ownerDocument.activeElement && this.statusBarContainer.contains(this.statusBarContainer.ownerDocument.activeElement)))) {
+				if (this._editor && (this._editor.hasWidgetFocus() || (DOM.getActiveElement(this.statusBarContainer.ownerDocument) && this.statusBarContainer.contains(DOM.getActiveElement(this.statusBarContainer.ownerDocument))))) {
 					element.focusMode = CellFocusMode.Editor;
 				} else {
 					const currentMode = element.focusMode;
@@ -167,9 +167,10 @@ export class CellEditorStatusBar extends CellContentPart {
 				// this is for a special case:
 				// users click the status bar empty space, which we will then focus the editor
 				// so we don't want to update the focus state too eagerly, it will be updated with onDidFocusEditorWidget
+				const activeElement = DOM.getActiveElement(this.statusBarContainer.ownerDocument);
 				if (
 					this._notebookEditor.hasEditorFocus() &&
-					!(this.statusBarContainer.ownerDocument.activeElement && this.statusBarContainer.contains(this.statusBarContainer.ownerDocument.activeElement))) {
+					!(activeElement && this.statusBarContainer.contains(activeElement))) {
 					updateFocusModeForEditorEvent();
 				}
 			}));
diff --git a/src/vs/workbench/contrib/notebook/browser/view/cellParts/codeCell.ts b/src/vs/workbench/contrib/notebook/browser/view/cellParts/codeCell.ts
index e828b4061fb..5f853cee926 100644
--- a/src/vs/workbench/contrib/notebook/browser/view/cellParts/codeCell.ts
+++ b/src/vs/workbench/contrib/notebook/browser/view/cellParts/codeCell.ts
@@ -34,7 +34,7 @@ import { CellEditorOptions } from './cellEditorOptions.js';
 import { CellOutputContainer } from './cellOutput.js';
 import { CollapsedCodeCellExecutionIcon } from './codeCellExecutionIcon.js';
 import { INotebookLoggingService } from '../../../common/notebookLoggingService.js';
-
+import { getActiveElement } from '../../../../../../base/browser/dom.js';
 
 export class CodeCell extends Disposable {
 	private _outputContainerRenderer: CellOutputContainer;
@@ -234,7 +234,7 @@ export class CodeCell extends Disposable {
 					if (
 						this.notebookEditor.getActiveCell() === this.viewCell &&
 						this.viewCell.focusMode === CellFocusMode.Editor &&
-						(this.notebookEditor.hasEditorFocus() || this.notebookEditor.getDomNode().ownerDocument.activeElement === this.notebookEditor.getDomNode().ownerDocument.body)) // Don't steal focus from other workbench parts, but if body has focus, we can take it
+						(this.notebookEditor.hasEditorFocus() || getActiveElement(this.notebookEditor.getDomNode().ownerDocument) === DOM.getRootContainer(this.notebookEditor.getDomNode()))) // Don't steal focus from other workbench parts, but if body has focus, we can take it
 					{
 						this.templateData.editor.focus();
 					}
@@ -500,7 +500,7 @@ export class CodeCell extends Disposable {
 		// the document active element is inside the notebook editor or the document body (cell editor being disposed previously)
 		return this.notebookEditor.getActiveCell() === this.viewCell
 			&& this.viewCell.focusMode === CellFocusMode.Editor
-			&& (this.notebookEditor.hasEditorFocus() || this.notebookEditor.getDomNode().ownerDocument.activeElement === this.notebookEditor.getDomNode().ownerDocument.body);
+			&& (this.notebookEditor.hasEditorFocus() || getActiveElement(this.notebookEditor.getDomNode().ownerDocument) === DOM.getRootContainer(this.notebookEditor.getDomNode()));
 	}
 
 	private updateEditorForFocusModeChange(sync: boolean) {
diff --git a/src/vs/workbench/contrib/notebook/browser/view/cellParts/markupCell.ts b/src/vs/workbench/contrib/notebook/browser/view/cellParts/markupCell.ts
index c1b90d72e8a..c3f41ccb0c0 100644
--- a/src/vs/workbench/contrib/notebook/browser/view/cellParts/markupCell.ts
+++ b/src/vs/workbench/contrib/notebook/browser/view/cellParts/markupCell.ts
@@ -226,7 +226,7 @@ export class MarkupCell extends Disposable {
 		this._isDisposed = true;
 
 		// move focus back to the cell list otherwise the focus goes to body
-		if (this.notebookEditor.getActiveCell() === this.viewCell && this.viewCell.focusMode === CellFocusMode.Editor && (this.notebookEditor.hasEditorFocus() || this.notebookEditor.getDomNode().ownerDocument.activeElement === this.notebookEditor.getDomNode().ownerDocument.body)) {
+		if (this.notebookEditor.getActiveCell() === this.viewCell && this.viewCell.focusMode === CellFocusMode.Editor && (this.notebookEditor.hasEditorFocus() || DOM.getActiveElement(this.notebookEditor.getDomNode().ownerDocument) === DOM.getRootContainer(this.notebookEditor.getDomNode()))) {
 			this.notebookEditor.focusContainer();
 		}
 
@@ -417,7 +417,7 @@ export class MarkupCell extends Disposable {
 
 	private focusEditorIfNeeded() {
 		if (this.viewCell.focusMode === CellFocusMode.Editor &&
-			(this.notebookEditor.hasEditorFocus() || this.notebookEditor.getDomNode().ownerDocument.activeElement === this.notebookEditor.getDomNode().ownerDocument.body)
+			(this.notebookEditor.hasEditorFocus() || DOM.getActiveElement(this.notebookEditor.getDomNode().ownerDocument) === DOM.getRootContainer(this.notebookEditor.getDomNode()))
 		) { // Don't steal focus from other workbench parts, but if body has focus, we can take it
 			if (!this.editor) {
 				return;
@@ -522,7 +522,7 @@ export class MarkupCell extends Disposable {
 			// this is for a special case:
 			// users click the status bar empty space, which we will then focus the editor
 			// so we don't want to update the focus state too eagerly
-			if (this.templateData.container.ownerDocument.activeElement?.contains(this.templateData.container)) {
+			if (DOM.getActiveElement(this.templateData.container.ownerDocument)?.contains(this.templateData.container)) {
 				this.focusSwitchDisposable.value = disposableTimeout(() => updateFocusMode(), 300);
 			} else {
 				updateFocusMode();
diff --git a/src/vs/workbench/contrib/notebook/browser/view/notebookCellList.ts b/src/vs/workbench/contrib/notebook/browser/view/notebookCellList.ts
index c9d5a62989d..4ed8197a376 100644
--- a/src/vs/workbench/contrib/notebook/browser/view/notebookCellList.ts
+++ b/src/vs/workbench/contrib/notebook/browser/view/notebookCellList.ts
@@ -1294,12 +1294,13 @@ export class NotebookCellList extends WorkbenchList<CellViewModel> implements ID
 		const focused = this.getFocusedElements()[0];
 		const focusedDomElement = focused && this.domElementOfElement(focused);
 
-		if (this.view.domNode.ownerDocument.activeElement && focusedDomElement && focusedDomElement.contains(this.view.domNode.ownerDocument.activeElement)) {
+		const activeElement = DOM.getActiveElement(this.view.domNode.ownerDocument);
+		if (activeElement && focusedDomElement && focusedDomElement.contains(activeElement)) {
 			// for example, when focus goes into monaco editor, if we refocus the list view, the editor will lose focus.
 			return;
 		}
 
-		if (!isMacintosh && this.view.domNode.ownerDocument.activeElement && !!DOM.findParentWithClass(<HTMLElement>this.view.domNode.ownerDocument.activeElement, 'context-view')) {
+		if (!isMacintosh && activeElement && !!DOM.findParentWithClass(<HTMLElement>activeElement, 'context-view')) {
 			return;
 		}
 
diff --git a/src/vs/workbench/contrib/notebook/browser/view/renderers/backLayerWebView.ts b/src/vs/workbench/contrib/notebook/browser/view/renderers/backLayerWebView.ts
index d3c4ea3f178..ff3d9c4b33a 100644
--- a/src/vs/workbench/contrib/notebook/browser/view/renderers/backLayerWebView.ts
+++ b/src/vs/workbench/contrib/notebook/browser/view/renderers/backLayerWebView.ts
@@ -3,7 +3,6 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-import { getWindow } from '../../../../../../base/browser/dom.js';
 import { IMouseWheelEvent } from '../../../../../../base/browser/mouseEvent.js';
 import { CodeWindow } from '../../../../../../base/browser/window.js';
 import { WorkbenchActionExecutedClassification, WorkbenchActionExecutedEvent } from '../../../../../../base/common/actions.js';
@@ -586,7 +585,7 @@ export class BackLayerWebView<T extends ICommonCellInfo> extends Themable {
 	}
 
 	private _initialize(content: string, targetWindow: CodeWindow): Promise<void> {
-		if (!getWindow(this.element).document.body.contains(this.element)) {
+		if (!this.element.isConnected) {
 			throw new Error('Element is already detached from the DOM tree');
 		}
 
diff --git a/src/vs/workbench/contrib/preferences/browser/preferences.contribution.ts b/src/vs/workbench/contrib/preferences/browser/preferences.contribution.ts
index dc4ed6e1f88..8f72885c81b 100644
--- a/src/vs/workbench/contrib/preferences/browser/preferences.contribution.ts
+++ b/src/vs/workbench/contrib/preferences/browser/preferences.contribution.ts
@@ -3,6 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
+import { getActiveElement } from '../../../../base/browser/dom.js';
 import { KeyChord, KeyCode, KeyMod } from '../../../../base/common/keyCodes.js';
 import { Disposable, DisposableStore, MutableDisposable } from '../../../../base/common/lifecycle.js';
 import { Schemas } from '../../../../base/common/network.js';
@@ -746,7 +747,7 @@ class PreferencesActionsContribution extends Disposable implements IWorkbenchCon
 					return;
 				}
 
-				const activeElement = preferencesEditor.getContainer()?.ownerDocument.activeElement;
+				const activeElement = getActiveElement(preferencesEditor.getContainer()?.ownerDocument);
 				if (activeElement?.classList.contains('monaco-list')) {
 					preferencesEditor.focusSettings(true);
 				}
diff --git a/src/vs/workbench/contrib/preferences/browser/settingsEditor2.ts b/src/vs/workbench/contrib/preferences/browser/settingsEditor2.ts
index db818b43764..abe4e29b499 100644
--- a/src/vs/workbench/contrib/preferences/browser/settingsEditor2.ts
+++ b/src/vs/workbench/contrib/preferences/browser/settingsEditor2.ts
@@ -1189,7 +1189,7 @@ export class SettingsEditor2 extends EditorPane {
 		}));
 
 		this._register(this.settingsTree.onDidFocus(() => {
-			const classList = container.ownerDocument.activeElement?.classList;
+			const classList = DOM.getActiveElement(container.ownerDocument)?.classList;
 			if (classList && classList.contains('monaco-list') && classList.contains('settings-editor-tree')) {
 				this._currentFocusContext = SettingsFocusContext.SettingTree;
 				this.settingRowFocused.set(true);
@@ -1709,7 +1709,7 @@ export class SettingsEditor2 extends EditorPane {
 
 	private getActiveControlInSettingsTree(): HTMLElement | null {
 		const element = this.settingsTree.getHTMLElement();
-		const activeElement = element.ownerDocument.activeElement;
+		const activeElement = DOM.getActiveElement(element.ownerDocument);
 		return (activeElement && DOM.isAncestorOfActiveElement(element)) ?
 			<HTMLElement>activeElement :
 			null;
@@ -1774,7 +1774,7 @@ export class SettingsEditor2 extends EditorPane {
 	}
 
 	private contextViewFocused(): boolean {
-		return !!DOM.findParentWithClass(<HTMLElement>this.rootElement.ownerDocument.activeElement, 'context-view');
+		return !!DOM.findParentWithClass(<HTMLElement>DOM.getActiveElement(this.rootElement.ownerDocument), 'context-view');
 	}
 
 	private refreshSingleElement(element: SettingsTreeSettingElement): void {
diff --git a/src/vs/workbench/contrib/terminal/browser/terminalTabbedView.ts b/src/vs/workbench/contrib/terminal/browser/terminalTabbedView.ts
index 7a3dd584458..b58e3170ff1 100644
--- a/src/vs/workbench/contrib/terminal/browser/terminalTabbedView.ts
+++ b/src/vs/workbench/contrib/terminal/browser/terminalTabbedView.ts
@@ -590,7 +590,7 @@ export class TerminalTabbedView extends Disposable {
 
 		// If the terminal is waiting to reconnect to remote terminals, then there is no TerminalInstance yet that can
 		// be focused. So wait for connection to finish, then focus.
-		const previousActiveElement = this._tabListElement.ownerDocument.activeElement;
+		const previousActiveElement = dom.getActiveElement(this._tabListElement.ownerDocument);
 		if (previousActiveElement) {
 			const listener = this._register(Event.once(this._terminalService.onDidChangeConnectionState)(() => {
 				// Only focus the terminal if the activeElement has not changed since focus() was called
diff --git a/src/vs/workbench/contrib/terminal/browser/terminalView.ts b/src/vs/workbench/contrib/terminal/browser/terminalView.ts
index 9a745727415..32b87509ab3 100644
--- a/src/vs/workbench/contrib/terminal/browser/terminalView.ts
+++ b/src/vs/workbench/contrib/terminal/browser/terminalView.ts
@@ -335,7 +335,7 @@ export class TerminalViewPane extends ViewPane {
 
 		// If the terminal is waiting to reconnect to remote terminals, then there is no TerminalInstance yet that can
 		// be focused. So wait for connection to finish, then focus.
-		const previousActiveElement = this.element.ownerDocument.activeElement;
+		const previousActiveElement = dom.getActiveElement(this.element.ownerDocument);
 		if (previousActiveElement) {
 			const listener = this._register(Event.once(this._terminalService.onDidChangeConnectionState)(() => {
 				// Only focus the terminal if the activeElement has not changed since focus() was called
diff --git a/src/vs/workbench/contrib/webview/browser/webviewElement.ts b/src/vs/workbench/contrib/webview/browser/webviewElement.ts
index 32ade0b6580..60d01c4415c 100644
--- a/src/vs/workbench/contrib/webview/browser/webviewElement.ts
+++ b/src/vs/workbench/contrib/webview/browser/webviewElement.ts
@@ -4,7 +4,7 @@
  *--------------------------------------------------------------------------------------------*/
 
 import { isFirefox } from '../../../../base/browser/browser.js';
-import { addDisposableListener, EventType, getWindow, getWindowById } from '../../../../base/browser/dom.js';
+import { addDisposableListener, EventType, getActiveElement, getWindow, getWindowById } from '../../../../base/browser/dom.js';
 import { parentOriginHash } from '../../../../base/browser/iframe.js';
 import { IMouseWheelEvent } from '../../../../base/browser/mouseEvent.js';
 import { CodeWindow } from '../../../../base/browser/window.js';
@@ -111,7 +111,8 @@ export class WebviewElement extends Disposable implements IWebviewElement, Webvi
 			return false;
 		}
 
-		if (this.window.document.activeElement && this.window.document.activeElement !== this.element) {
+		const activeElement = getActiveElement(this.window.document)
+		if (activeElement && activeElement !== this.element) {
 			// looks like https://github.com/microsoft/vscode/issues/132641
 			// where the focus is actually not in the `<iframe>`
 			return false;
@@ -850,8 +851,11 @@ export class WebviewElement extends Disposable implements IWebviewElement, Webvi
 				return;
 			}
 
-			if (this.window?.document.activeElement && this.window.document.activeElement !== this.element && this.window.document.activeElement?.tagName !== 'BODY') {
-				return;
+			if (this.window) {
+				const activeElement = getActiveElement(this.window?.document)
+				if (activeElement && activeElement !== this.element && activeElement?.tagName !== 'BODY') {
+					return;
+				}
 			}
 
 			// It is possible for the webview to be contained in another window
diff --git a/src/vs/workbench/contrib/welcomeGettingStarted/browser/gettingStarted.ts b/src/vs/workbench/contrib/welcomeGettingStarted/browser/gettingStarted.ts
index 6a70526e4c7..ac42ef8d2bf 100644
--- a/src/vs/workbench/contrib/welcomeGettingStarted/browser/gettingStarted.ts
+++ b/src/vs/workbench/contrib/welcomeGettingStarted/browser/gettingStarted.ts
@@ -3,7 +3,7 @@
  *  Licensed under the MIT License. See License.txt in the project root for license information.
  *--------------------------------------------------------------------------------------------*/
 
-import { $, Dimension, addDisposableListener, append, clearNode, reset } from '../../../../base/browser/dom.js';
+import { $, Dimension, addDisposableListener, append, clearNode, getActiveElement, reset } from '../../../../base/browser/dom.js';
 import { renderFormattedText } from '../../../../base/browser/formattedTextRenderer.js';
 import { status } from '../../../../base/browser/ui/aria/aria.js';
 import { StandardKeyboardEvent } from '../../../../base/browser/keyboardEvent.js';
@@ -1745,7 +1745,7 @@ export class GettingStartedPage extends EditorPane {
 	override focus() {
 		super.focus();
 
-		const active = this.container.ownerDocument.activeElement;
+		const active = getActiveElement(this.container.ownerDocument);
 
 		let parent = this.container.parentElement;
 		while (parent && parent !== active) {
diff --git a/src/vs/workbench/contrib/welcomeWalkthrough/browser/walkThroughPart.ts b/src/vs/workbench/contrib/welcomeWalkthrough/browser/walkThroughPart.ts
index 27908c633b0..ef61127e428 100644
--- a/src/vs/workbench/contrib/welcomeWalkthrough/browser/walkThroughPart.ts
+++ b/src/vs/workbench/contrib/welcomeWalkthrough/browser/walkThroughPart.ts
@@ -32,8 +32,8 @@ import { UILabelProvider } from '../../../../base/common/keybindingLabels.js';
 import { OS, OperatingSystem } from '../../../../base/common/platform.js';
 import { deepClone } from '../../../../base/common/objects.js';
 import { INotificationService } from '../../../../platform/notification/common/notification.js';
-import { addDisposableListener, Dimension, isHTMLAnchorElement, isHTMLButtonElement, isHTMLElement, size } from '../../../../base/browser/dom.js';
 import * as domSanitize from '../../../../base/browser/domSanitize.js';
+import { addDisposableListener, Dimension, getActiveElement, isHTMLAnchorElement, isHTMLButtonElement, isHTMLElement, size } from '../../../../base/browser/dom.js';
 import { IEditorGroup, IEditorGroupsService } from '../../../services/editor/common/editorGroupsService.js';
 import { CancellationToken } from '../../../../base/common/cancellation.js';
 import { IExtensionService } from '../../../services/extensions/common/extensions.js';
@@ -159,7 +159,7 @@ export class WalkThroughPart extends EditorPane {
 			for (let node = event.target as HTMLElement; node; node = node.parentNode as HTMLElement) {
 				if (isHTMLAnchorElement(node) && node.href) {
 					// eslint-disable-next-line no-restricted-syntax
-					const baseElement = node.ownerDocument.getElementsByTagName('base')[0] || this.window.location;
+					const baseElement = (node.getRootNode() as ShadowRoot | Document).querySelector('base') || this.window.location;
 					if (baseElement && node.href.indexOf(baseElement.href) >= 0 && node.hash) {
 						// eslint-disable-next-line no-restricted-syntax
 						const scrollTarget = this.content.querySelector(node.hash);
@@ -230,7 +230,7 @@ export class WalkThroughPart extends EditorPane {
 	override focus(): void {
 		super.focus();
 
-		let active = this.content.ownerDocument.activeElement;
+		let active = getActiveElement(this.content.ownerDocument);
 		while (active && active !== this.content) {
 			active = active.parentElement;
 		}
diff --git a/src/vs/workbench/services/suggest/browser/simpleSuggestWidget.ts b/src/vs/workbench/services/suggest/browser/simpleSuggestWidget.ts
index 1245acce54c..a2312b0d332 100644
--- a/src/vs/workbench/services/suggest/browser/simpleSuggestWidget.ts
+++ b/src/vs/workbench/services/suggest/browser/simpleSuggestWidget.ts
@@ -355,7 +355,7 @@ export class SimpleSuggestWidget<TModel extends SimpleCompletionModel<TItem>, TI
 			this._list.reveal(index);
 
 			const id = getAriaId(index);
-			const node = dom.getActiveWindow().document.activeElement;
+			const node = dom.getActiveElement();
 			if (node && id) {
 				node.setAttribute('aria-haspopup', 'true');
 				node.setAttribute('aria-autocomplete', 'list');
@@ -405,7 +405,7 @@ export class SimpleSuggestWidget<TModel extends SimpleCompletionModel<TItem>, TI
 	}
 
 	private _clearAriaActiveDescendant(): void {
-		const node = dom.getActiveWindow().document.activeElement;
+		const node = dom.getActiveElement();
 		if (!node) {
 			return;
 		}
diff --git a/src/vs/workbench/services/themes/browser/workbenchThemeService.ts b/src/vs/workbench/services/themes/browser/workbenchThemeService.ts
index e286ec94d86..6e733d0fbb1 100644
--- a/src/vs/workbench/services/themes/browser/workbenchThemeService.ts
+++ b/src/vs/workbench/services/themes/browser/workbenchThemeService.ts
@@ -804,7 +804,7 @@ class ThemeFileWatcher {
 
 function _applyRules(styleSheetContent: string, rulesClassName: string) {
 	// eslint-disable-next-line no-restricted-syntax
-	const themeStyles = mainWindow.document.head.getElementsByClassName(rulesClassName);
+	const themeStyles = mainWindow.document.head.querySelectorAll(`.${rulesClassName}`);
 	if (themeStyles.length === 0) {
 		const elStyle = createStyleSheet();
 		elStyle.className = rulesClassName;
