From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lo=C3=AFc=20Mangeonjean?= <loic@coderpad.io>
Date: Mon, 4 Aug 2025 19:03:44 +0200
Subject: [PATCH] feat: support loading VSCode in an iframe

---
 src/vs/base/browser/dom.ts                    | 39 +++++++------------
 src/vs/base/browser/domStylesheets.ts         |  4 +-
 src/vs/base/browser/window.ts                 |  7 +++-
 src/vs/workbench/browser/window.ts            | 25 ++++++++----
 .../browser/view/renderers/webviewPreloads.ts |  4 +-
 .../performance/browser/perfviewEditor.ts     |  3 +-
 .../performance/browser/startupTimings.ts     |  3 +-
 .../browser/webWorkerExtensionHost.ts         |  6 +--
 .../lifecycle/browser/lifecycleService.ts     |  2 +-
 9 files changed, 49 insertions(+), 44 deletions(-)

diff --git a/src/vs/base/browser/dom.ts b/src/vs/base/browser/dom.ts
index b139ab720ed..007b2fa0e33 100644
--- a/src/vs/base/browser/dom.ts
+++ b/src/vs/base/browser/dom.ts
@@ -1015,68 +1015,55 @@ function createHeadElement(tagName: string, container: HTMLElement = mainWindow.
 }
 
 export function isHTMLElement(e: unknown): e is HTMLElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof HTMLElement || e instanceof getWindow(e as Node).HTMLElement;
+	return e instanceof mainWindow.HTMLElement || e instanceof getWindow(e as Node).HTMLElement;
 }
 
 export function isHTMLAnchorElement(e: unknown): e is HTMLAnchorElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof HTMLAnchorElement || e instanceof getWindow(e as Node).HTMLAnchorElement;
+	return e instanceof mainWindow.HTMLAnchorElement || e instanceof getWindow(e as Node).HTMLAnchorElement;
 }
 
 export function isHTMLSpanElement(e: unknown): e is HTMLSpanElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof HTMLSpanElement || e instanceof getWindow(e as Node).HTMLSpanElement;
+	return e instanceof mainWindow.HTMLSpanElement || e instanceof getWindow(e as Node).HTMLSpanElement;
 }
 
 export function isHTMLTextAreaElement(e: unknown): e is HTMLTextAreaElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof HTMLTextAreaElement || e instanceof getWindow(e as Node).HTMLTextAreaElement;
+	return e instanceof mainWindow.HTMLTextAreaElement || e instanceof getWindow(e as Node).HTMLTextAreaElement;
 }
 
 export function isHTMLInputElement(e: unknown): e is HTMLInputElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof HTMLInputElement || e instanceof getWindow(e as Node).HTMLInputElement;
+	return e instanceof mainWindow.HTMLInputElement || e instanceof getWindow(e as Node).HTMLInputElement;
 }
 
 export function isHTMLButtonElement(e: unknown): e is HTMLButtonElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof HTMLButtonElement || e instanceof getWindow(e as Node).HTMLButtonElement;
+	return e instanceof mainWindow.HTMLButtonElement || e instanceof getWindow(e as Node).HTMLButtonElement;
 }
 
 export function isHTMLDivElement(e: unknown): e is HTMLDivElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof HTMLDivElement || e instanceof getWindow(e as Node).HTMLDivElement;
+	return e instanceof mainWindow.HTMLDivElement || e instanceof getWindow(e as Node).HTMLDivElement;
 }
 
 export function isHTMLIframeElement(e: unknown): e is HTMLDivElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof HTMLIFrameElement || e instanceof getWindow(e as Node).HTMLIFrameElement;
+	return e instanceof mainWindow.HTMLIFrameElement || e instanceof getWindow(e as Node).HTMLIFrameElement;
 }
 
 export function isSVGElement(e: unknown): e is SVGElement {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof SVGElement || e instanceof getWindow(e as Node).SVGElement;
+	return e instanceof mainWindow.SVGElement || e instanceof getWindow(e as Node).SVGElement;
 }
 
 export function isMouseEvent(e: unknown): e is MouseEvent {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof MouseEvent || e instanceof getWindow(e as UIEvent).MouseEvent;
+	return e instanceof mainWindow.MouseEvent || e instanceof getWindow(e as UIEvent).MouseEvent;
 }
 
 export function isKeyboardEvent(e: unknown): e is KeyboardEvent {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof KeyboardEvent || e instanceof getWindow(e as UIEvent).KeyboardEvent;
+	return e instanceof mainWindow.KeyboardEvent || e instanceof getWindow(e as UIEvent).KeyboardEvent;
 }
 
 export function isPointerEvent(e: unknown): e is PointerEvent {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof PointerEvent || e instanceof getWindow(e as UIEvent).PointerEvent;
+	return e instanceof mainWindow.PointerEvent || e instanceof getWindow(e as UIEvent).PointerEvent;
 }
 
 export function isDragEvent(e: unknown): e is DragEvent {
-	// eslint-disable-next-line no-restricted-syntax
-	return e instanceof DragEvent || e instanceof getWindow(e as UIEvent).DragEvent;
+	return e instanceof mainWindow.DragEvent || e instanceof getWindow(e as UIEvent).DragEvent;
 }
 
 export const EventType = {
diff --git a/src/vs/base/browser/domStylesheets.ts b/src/vs/base/browser/domStylesheets.ts
index 0062f78f857..357dd598fb3 100644
--- a/src/vs/base/browser/domStylesheets.ts
+++ b/src/vs/base/browser/domStylesheets.ts
@@ -5,7 +5,7 @@
 
 import { DisposableStore, toDisposable, IDisposable } from '../common/lifecycle.js';
 import { autorun, IObservable } from '../common/observable.js';
-import { getWindows, sharedMutationObserver } from './dom.js';
+import { getWindows, isShadowRoot, sharedMutationObserver } from './dom.js';
 import { mainWindow } from './window.js';
 
 const globalStylesheets = new Map<HTMLStyleElement /* main stylesheet */, Set<HTMLStyleElement /* aux window clones that track the main stylesheet */>>();
@@ -49,7 +49,7 @@ class WrappedStyleElement {
 export let shadowRootContainer: ShadowRoot | undefined;
 export function setContainerElement(container: HTMLElement) {
 	const root = container.getRootNode();
-	if (root instanceof ShadowRoot) {
+	if (isShadowRoot(root)) {
 		shadowRootContainer = root;
 	}
 }
diff --git a/src/vs/base/browser/window.ts b/src/vs/base/browser/window.ts
index ab920e18349..c4a02c5ca47 100644
--- a/src/vs/base/browser/window.ts
+++ b/src/vs/base/browser/window.ts
@@ -17,8 +17,13 @@ export function ensureCodeWindow(targetWindow: Window, fallbackWindowId: number)
 	}
 }
 
+declare global {
+	// eslint-disable-next-line no-var
+	var vscodeWindow: Window | undefined;
+}
+
 // eslint-disable-next-line no-restricted-globals
-export const mainWindow = window as CodeWindow;
+export const mainWindow = (window.vscodeWindow ?? window) as CodeWindow;
 
 export function isAuxiliaryWindow(obj: Window): obj is CodeWindow {
 	if (obj === mainWindow) {
diff --git a/src/vs/workbench/browser/window.ts b/src/vs/workbench/browser/window.ts
index 70e83ad4396..44678fae826 100644
--- a/src/vs/workbench/browser/window.ts
+++ b/src/vs/workbench/browser/window.ts
@@ -109,13 +109,22 @@ export abstract class BaseWindow extends Disposable {
 		// to throttle timeouts in minimized windows, so with this we can ensure the
 		// timeout is scheduled without being throttled (unless all windows are minimized).
 
-		const originalSetTimeout = targetWindow.setTimeout;
-		Object.defineProperty(targetWindow, 'vscodeOriginalSetTimeout', { get: () => originalSetTimeout });
+		function getOverridenWindow(targetWindow: Window) {
+			if (targetWindow === mainWindow) {
+				// If running inside an iframe, do not override the `setTimeout` function on the main frame
+				// eslint-disable-next-line no-restricted-globals
+				return window;
+			}
+			return targetWindow;
+		}
+
+		const originalSetTimeout = getOverridenWindow(targetWindow).setTimeout;
+		Object.defineProperty(getOverridenWindow(targetWindow), 'vscodeOriginalSetTimeout', { get: () => originalSetTimeout });
 
-		const originalClearTimeout = targetWindow.clearTimeout;
-		Object.defineProperty(targetWindow, 'vscodeOriginalClearTimeout', { get: () => originalClearTimeout });
+		const originalClearTimeout = getOverridenWindow(targetWindow).clearTimeout;
+		Object.defineProperty(getOverridenWindow(targetWindow), 'vscodeOriginalClearTimeout', { get: () => originalClearTimeout });
 
-		targetWindow.setTimeout = function (this: unknown, handler: TimerHandler, timeout = 0, ...args: unknown[]): number {
+		getOverridenWindow(targetWindow).setTimeout = function (this: unknown, handler: TimerHandler, timeout = 0, ...args: unknown[]): number {
 			if (dom.getWindowsCount() === 1 || typeof handler === 'string' || timeout === 0 /* immediates are never throttled */) {
 				return originalSetTimeout.apply(this, [handler, timeout, ...args]);
 			}
@@ -138,7 +147,7 @@ export abstract class BaseWindow extends Disposable {
 				// this can happen for timeouts on unfocused windows
 				let didClear = false;
 
-				const handle = (window as any).vscodeOriginalSetTimeout.apply(this, [(...args: unknown[]) => {
+				const handle = (getOverridenWindow(targetWindow) as any).vscodeOriginalSetTimeout.apply(this, [(...args: unknown[]) => {
 					if (didClear) {
 						return;
 					}
@@ -147,7 +156,7 @@ export abstract class BaseWindow extends Disposable {
 
 				const timeoutDisposable = toDisposable(() => {
 					didClear = true;
-					(window as any).vscodeOriginalClearTimeout(handle);
+					(getOverridenWindow(targetWindow) as any).vscodeOriginalClearTimeout(handle);
 					timeoutDisposables.delete(timeoutDisposable);
 				});
 
@@ -158,7 +167,7 @@ export abstract class BaseWindow extends Disposable {
 			return timeoutHandle;
 		};
 
-		targetWindow.clearTimeout = function (this: unknown, timeoutHandle: number | undefined): void {
+		getOverridenWindow(targetWindow).clearTimeout = function (this: unknown, timeoutHandle: number | undefined): void {
 			const timeoutDisposables = typeof timeoutHandle === 'number' ? BaseWindow.TIMEOUT_DISPOSABLES.get(timeoutHandle) : undefined;
 			if (timeoutDisposables) {
 				dispose(timeoutDisposables);
diff --git a/src/vs/workbench/contrib/notebook/browser/view/renderers/webviewPreloads.ts b/src/vs/workbench/contrib/notebook/browser/view/renderers/webviewPreloads.ts
index 8706def9f28..26257a9d2e4 100644
--- a/src/vs/workbench/contrib/notebook/browser/view/renderers/webviewPreloads.ts
+++ b/src/vs/workbench/contrib/notebook/browser/view/renderers/webviewPreloads.ts
@@ -9,6 +9,8 @@ import type * as webviewMessages from './webviewMessages.js';
 import type { NotebookCellMetadata } from '../../../common/notebookCommon.js';
 import type * as rendererApi from 'vscode-notebook-renderer';
 import type { NotebookCellOutputTransferData } from '../../../../../../platform/dnd/browser/dnd.js';
+// eslint-disable-next-line local/code-no-runtime-import
+import { isShadowRoot } from '../../../../../../base/browser/dom.js';
 
 // !! IMPORTANT !! ----------------------------------------------------------------------------------
 // import { RenderOutputType } from 'vs/workbench/contrib/notebook/browser/notebookBrowser';
@@ -2463,7 +2465,7 @@ async function webviewPreloads(ctx: PreloadContext) {
 			const trustedHtml = ttPolicy?.createHTML(html) ?? html;
 			el.innerHTML = trustedHtml as string; // CodeQL [SM03712] The rendered content comes from VS Code's tokenizer and is considered safe
 			const root = el.getRootNode();
-			if (root instanceof ShadowRoot) {
+			if (isShadowRoot(root)) {
 				if (!root.adoptedStyleSheets.includes(tokenizationStyle)) {
 					root.adoptedStyleSheets.push(tokenizationStyle);
 				}
diff --git a/src/vs/workbench/contrib/performance/browser/perfviewEditor.ts b/src/vs/workbench/contrib/performance/browser/perfviewEditor.ts
index b56d0efeeb9..cf0c8248890 100644
--- a/src/vs/workbench/contrib/performance/browser/perfviewEditor.ts
+++ b/src/vs/workbench/contrib/performance/browser/perfviewEditor.ts
@@ -31,6 +31,7 @@ import { Registry } from '../../../../platform/registry/common/platform.js';
 import { IWorkbenchContributionsRegistry, Extensions as WorkbenchExtensions, getWorkbenchContribution } from '../../../common/contributions.js';
 import { ICustomEditorLabelService } from '../../../services/editor/common/customEditorLabelService.js';
 import { IRemoteAgentService } from '../../../services/remote/common/remoteAgentService.js';
+import { mainWindow } from '../../../../base/browser/window.js';
 
 export class PerfviewContrib {
 
@@ -308,7 +309,7 @@ class PerfModelContentProvider implements ITextModelContentProvider {
 	}
 
 	private _addResourceTimingStats(md: MarkdownBuilder) {
-		const stats = performance.getEntriesByType('resource').map(entry => {
+		const stats = mainWindow.performance.getEntriesByType('resource').map(entry => {
 			return [entry.name, entry.duration];
 		});
 		if (!stats.length) {
diff --git a/src/vs/workbench/contrib/performance/browser/startupTimings.ts b/src/vs/workbench/contrib/performance/browser/startupTimings.ts
index eb0a9ffbc42..b6a71a21ce4 100644
--- a/src/vs/workbench/contrib/performance/browser/startupTimings.ts
+++ b/src/vs/workbench/contrib/performance/browser/startupTimings.ts
@@ -19,6 +19,7 @@ import { ITimerService } from '../../../services/timer/browser/timerService.js';
 import { IWorkbenchContribution } from '../../../common/contributions.js';
 import { posix } from '../../../../base/common/path.js';
 import { hash } from '../../../../base/common/hash.js';
+import { mainWindow } from '../../../../base/browser/window.js';
 
 export abstract class StartupTimings {
 
@@ -121,7 +122,7 @@ export class BrowserResourcePerformanceMarks {
 			name: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Resource basename' };
 			duration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Resource duration' };
 		};
-		for (const item of performance.getEntriesByType('resource')) {
+		for (const item of mainWindow.performance.getEntriesByType('resource')) {
 
 			try {
 				const url = new URL(item.name);
diff --git a/src/vs/workbench/services/extensions/browser/webWorkerExtensionHost.ts b/src/vs/workbench/services/extensions/browser/webWorkerExtensionHost.ts
index d42138bea2e..24068d0cd76 100644
--- a/src/vs/workbench/services/extensions/browser/webWorkerExtensionHost.ts
+++ b/src/vs/workbench/services/extensions/browser/webWorkerExtensionHost.ts
@@ -198,7 +198,7 @@ export class WebWorkerExtensionHost extends Disposable implements IExtensionHost
 				return;
 			}
 			const { data } = event.data;
-			if (barrier.isOpen() || !(data instanceof MessagePort)) {
+			if (barrier.isOpen() || !(data instanceof mainWindow.MessagePort)) {
 				console.warn('UNEXPECTED message', event);
 				const err = new Error('UNEXPECTED message');
 				return rejectBarrier(ExtensionHostExitCode.UnexpectedError, err);
@@ -223,12 +223,12 @@ export class WebWorkerExtensionHost extends Disposable implements IExtensionHost
 
 		port.onmessage = (event) => {
 			const { data } = event;
-			if (!(data instanceof ArrayBuffer)) {
+			if (!(data instanceof mainWindow.ArrayBuffer)) {
 				console.warn('UNKNOWN data received', data);
 				this._onDidExit.fire([77, 'UNKNOWN data received']);
 				return;
 			}
-			emitter.fire(VSBuffer.wrap(new Uint8Array(data, 0, data.byteLength)));
+			emitter.fire(VSBuffer.wrap(new mainWindow.Uint8Array(data, 0, data.byteLength)));
 		};
 
 		const protocol: IMessagePassingProtocol = {
diff --git a/src/vs/workbench/services/lifecycle/browser/lifecycleService.ts b/src/vs/workbench/services/lifecycle/browser/lifecycleService.ts
index 5bacc9fad6b..36f6d7776ed 100644
--- a/src/vs/workbench/services/lifecycle/browser/lifecycleService.ts
+++ b/src/vs/workbench/services/lifecycle/browser/lifecycleService.ts
@@ -208,7 +208,7 @@ export class BrowserLifecycleService extends AbstractLifecycleService {
 	protected override doResolveStartupKind(): StartupKind | undefined {
 		let startupKind = super.doResolveStartupKind();
 		if (typeof startupKind !== 'number') {
-			const timing = performance.getEntriesByType('navigation').at(0) as PerformanceNavigationTiming | undefined;
+			const timing = mainWindow.performance.getEntriesByType('navigation').at(0) as PerformanceNavigationTiming | undefined;
 			if (timing?.type === 'reload') {
 				// MDN: https://developer.mozilla.org/en-US/docs/Web/API/PerformanceNavigationTiming/type#value
 				startupKind = StartupKind.ReloadedWindow;
