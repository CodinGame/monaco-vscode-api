#!/bin/bash
set -e

output_directory="`pwd`/vscode"
rm -rf $output_directory

build_directory=`mktemp -d`
echo "Downloading vscode in $build_directory..."

curl https://codeload.github.com/microsoft/vscode/tar.gz/refs/tags/1.68.0 | tar -xz -C $build_directory --strip-components=1 vscode-1.68.0
cd $build_directory

echo "Installing vscode dependencies..."
yarn install --ignore-scripts

echo "Patching vscode..."
cd src
# Export required class from vscode code
cat <<EOF >> ./vs/workbench/api/common/extHostLanguageFeatures.ts

export {
	CompletionsAdapter,
	CodeActionAdapter,
	CodeLensAdapter,
	DefinitionAdapter,
	ImplementationAdapter,
	TypeDefinitionAdapter,
	DeclarationAdapter,
	HoverAdapter,
	DocumentHighlightAdapter,
	DocumentSymbolAdapter,
	ReferenceAdapter,
	RenameAdapter,
	DocumentFormattingAdapter,
	RangeFormattingAdapter,
	OnTypeFormattingAdapter,
	SignatureHelpAdapter,
	LinkProviderAdapter,
	ColorProviderAdapter,
	FoldingProviderAdapter,
	SelectionRangeAdapter,
	InlayHintsAdapter,
	EvaluatableExpressionAdapter,
	LinkedEditingRangeAdapter,
	TypeHierarchyAdapter,
	CallHierarchyAdapter,
	NavigateTypeAdapter,
	InlineCompletionAdapter
};
EOF

# Mark some methods as public
sed -i 's/private static/public static/g' ./vs/workbench/api/browser/mainThreadLanguageFeatures.ts
sed -i 's/private static/public static/g' ./vs/workbench/api/common/extHostLanguageFeatures.ts


# Remove useless files
rm -rf `find . -name '*.test.ts' -o -name 'test' -o -name 'electron-browser'`
rm -rf vs/code
rm -rf vs/server

# Change import syntax so it builds to ESM
sed -i 's/import semver = require(\x27vs\/base\/common\/semver\/semver\x27);/import \* as semver from \x27vs\/base\/common\/semver\/semver\x27;/g' vs/workbench/contrib/extensions/browser/extensionEditor.ts

echo "Building vscode..."
tsc --declaration --importHelpers --module es2020 --outDir "$output_directory/vs"
# Copy files that are already built
find ./vs \( -name '*.js' -o -name '*.d.ts' \) -exec cp --parents \{\} "$output_directory/" \;

echo "Cleaning..."
rm -rf $build_directory